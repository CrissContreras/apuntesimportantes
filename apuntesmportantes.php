https://siruio.kfc.com.ec/inicio/home.php
http://1sir.test:8080/
SRV-DESA-PROYEC\PRYSIR

git clone https://github.com/GrupoKFC/1sir.git

git branch -a

git checkout -b dev_sir remotes/origin/remotes/origin/dev_sir


composer install
composer dump-autoload
compuser update


[9:42] Darwin Mora
    usuario: dmora
​[9:42] Darwin Mora
    clave: ecuador*17


https://teams.microsoft.com/l/meetup-join/19%3a67aa6617c1424d2d839f628175283863%40thread.tacv2/1644243933598?context=%7b%22Tid%22%3a%220690cba8-a3a0-4aab-885f-27112ca1cb7e%22%2c%22Oid%22%3a%22d5a96282-9974-4177-b04e-e8892a636322%22%7d


https://teams.microsoft.com/l/meetup-join/19%3a67aa6617c1424d2d839f628175283863%40thread.tacv2/1644243933598?context=%7b%22Tid%22%3a%220690cba8-a3a0-4aab-885f-27112ca1cb7e%22%2c%22Oid%22%3a%22d5a96282-9974-4177-b04e-e8892a636322%22%7d

usuario: pruebas 
clave:pruebas123

************.env******************
MODE="development"
HOST="http://1sir.test:8080"
HOST_INIT=""
HOST_OLD=""
LOCATION="UIO"
LOCATION_NATIONAL="ECU"
LOCATION_ALL="QUITO"
DB_USER_ADMIN="dev_pruebas"
HOST_FRONT="http://1sir.test:8080"
URL_SERVE_SIR_API_INTEGRACION="http://1sir.test:8080"
URL_SERVE_SIR_API_SIR="http://1sir.test:8080"
SIR_1="http://1sir.test:8080"
#VUEJS
JS_VUE=app.0dee8ca0.js  
CHUCK_VUE=chunk-vendors.1aa05986.js  
CSS_VUE=app.73070c61.css  
CHUCK_CSS_VUE=chunk-vendors.f9374616.css

#2022 
DB_NA_HOST_ECU_2022=192.168.101.29\PRYSIR
DB_NA_BASE_ECU_2022=SirNacional_Ecu
DB_NA_USER_ECU_2022=dev_pruebas
DB_NA_PASS_ECU_2022="pruebas*88"
DB_RE_HOST_UIO_2022=192.168.101.29\PRYSIR
DB_RE_BASE_UIO_2022=SirSql_Ecu
DB_RE_USER_UIO_2022=dev_pruebas
DB_RE_PASS_UIO_2022="pruebas*88"
DB_RE_HOST_GYE_2022=192.168.101.29\PRYSIR
DB_RE_BASE_GYE_2022=SirSql_Ecu
DB_RE_USER_GYE_2022=dev_pruebas
DB_RE_PASS_GYE_2022="pruebas*88"


#2021 
DB_NA_HOST_ECU_2021=192.168.101.29\PRYSIR
DB_NA_BASE_ECU_2021=SirNacional_Ecu
DB_NA_USER_ECU_2021=dev_pruebas
DB_NA_PASS_ECU_2021="pruebas*88"
DB_RE_HOST_ECU_2021=192.168.101.29\PRYSIR
DB_RE_BASE_ECU_2021=SirSql_Ecu
DB_RE_USER_ECU_2021=dev_pruebas
DB_RE_PASS_ECU_2021="pruebas*88"
DB_NA_HOST_2021=192.168.101.29\PRYSIR
DB_NA_BASE_2021=SirNacional_Ecu
DB_NA_USER_2021=dev_pruebas
DB_NA_PASS_2021="pruebas*88"
DB_RE_HOST_UIO_2021=192.168.101.29\PRYSIR
DB_RE_BASE_UIO_2021=SirSql_Ecu
DB_RE_USER_UIO_2021=dev_pruebas
DB_RE_PASS_UIO_2021="pruebas*88"
DB_RE_HOST_GYE_2021=192.168.101.29\PRYSIR
DB_RE_BASE_GYE_2021=SirSql_Ecu
DB_RE_USER_GYE_2021=dev_pruebas
DB_RE_PASS_GYE_2021="pruebas*88"

#2021 
DB_NA_HOST_ECU_2021=192.168.101.29\PRYSIR
DB_NA_BASE_ECU_2021=SirNacional_Ecu
DB_NA_USER_ECU_2021=dev_pruebas
DB_NA_PASS_ECU_2021="pruebas*88"
DB_RE_HOST_ECU_2021=192.168.101.29\PRYSIR
DB_RE_BASE_ECU_2021=SirSql_Ecu
DB_RE_USER_ECU_2021=dev_pruebas
DB_RE_PASS_ECU_2021="pruebas*88"
DB_RE_HOST_ECU_2021=192.168.101.29\PRYSIR
DB_RE_BASE_ECU_2021=SirSql_Ecu
DB_RE_USER_ECU_2021=dev_pruebas
DB_RE_PASS_ECU_2021="pruebas*88"

#2020 
DB_NA_HOST_2020=192.168.101.29\PRYSIR
DB_NA_BASE_2020=GerenteNacionalR
DB_NA_USER_2020=dev_pruebas
DB_NA_PASS_2020="pruebas*88"
DB_RE_HOST_2020=192.168.101.29\PRYSIR
DB_RE_BASE_2020=SirSql_Ecu
DB_RE_USER_2020=dev_pruebas
DB_RE_PASS_2020="pruebas*88"

#2022
DB_NA_HOST_UIO_2020=192.168.101.29\PRYSIR
DB_NA_BASE_UIO_2020=GerenteNacionalR
DB_NA_USER_UIO_2020=dev_pruebas
DB_NA_PASS_UIO_2020="pruebas*88"
DB_RE_HOST_UIO_2020=192.168.101.29\PRYSIR
DB_RE_BASE_UIO_2020=SirSql_Ecu
DB_RE_USER_UIO_2020=dev_pruebas
DB_RE_PASS_UIO_2020="pruebas*88"
#2020 GYE
DB_NA_HOST_GYE_2020=192.168.101.29\PRYSIR
DB_NA_BASE_GYE_2020=SirSql_Ecu
DB_NA_USER_GYE_2020=dev_pruebas
DB_NA_PASS_GYE_2020="pruebas*88"
DB_RE_HOST_GYE_2020=192.168.101.29\PRYSIR
DB_RE_BASE_GYE_2020=SirSql_Ecu
DB_RE_USER_GYE_2020=dev_pruebas
DB_RE_PASS_GYE_2020="pruebas*88"
#2019 UIO
DB_NA_HOST_UIO_2019=192.168.101.29\PRYSIR
DB_NA_BASE_UIO_2019=GerenteNacionalR
DB_NA_USER_UIO_2019=dev_pruebas
DB_NA_PASS_UIO_2019="pruebas*88"
DB_RE_HOST_UIO_2019=192.168.101.29\PRYSIR
DB_RE_BASE_UIO_2019=SirSql_Ecu
DB_RE_USER_UIO_2019=dev_pruebas
DB_RE_PASS_UIO_2019="pruebas*88"
#2019 GYE
DB_NA_HOST_GYE_2019=192.168.101.29\PRYSIR
DB_NA_BASE_GYE_2019=SirSql_Ecu
DB_NA_USER_GYE_2019=dev_pruebas
DB_NA_PASS_GYE_2019="pruebas*88"
DB_RE_HOST_GYE_2019=192.168.101.29\PRYSIR
DB_RE_BASE_GYE_2019=SirSql_Ecu
DB_RE_USER_GYE_2019=dev_pruebas
DB_RE_PASS_GYE_2019="pruebas*88"

******************************************
select * from Solicitud where Cod_Solicitud = 'CKFCS017320'-- cabecera de cupones --fecha de vigencia
select * from Detalle_Solicitud where Cod_Solicitud = 'CKFCS017320' --detalle del cupon -- 1 activo estado
select * from Subdetalle_Solicitud where Cod_Detalle_Solicitud = 'CKFCM001741' -- en esta tabla es el cod_plu 197/361
select * from Subdetalle_Solicitud where Cod_Detalle_Solicitud = 'CKFCM001742' -- en esta tabla es el cod_plu 327713
select * from Solicitud_Cupon where Cod_Detalle_Solicitud = 'CKFCM001741' --estado 1 no está canjeados
select * from Solicitud_Cupon where Cod_Detalle_Solicitud = 'CKFCM001742' --estado 1 no está canjeados

select * from plus where Cod_plu = 361

select plu.cod_plu,cat.Descripcion, pre.Pvp,pre.Valor_Iva,pre.Valor_Neto,pre.Cod_Precio_plu,cat.Cod_Categoria from Categoria cat inner join Precio_plu pre on cat.Cod_Categoria=pre.Cod_Categoria inner join Plus plu on plu.Cod_Plu=pre.Cod_Plu where plu.Cod_Plu=32663 and plu.Estado=1 and cat.Estado=1 and pre.Estado=1 order by cat.descripcion

select * from Subdetalle_Solicitud where Cod_plu = 32663
select * from Solicitud where Cod_Solicitud IN(select Cod_Solicitud from Detalle_Solicitud where Cod_Detalle_Solicitud IN(select Cod_Detalle_Solicitud from Subdetalle_Solicitud where Cod_plu = 32663))

select distinct sol.Cod_Solicitud,sol.estado,sol.fecha_Vigencia,sub.Cod_Detalle_Solicitud,sub.Cod_plu 
From Solicitud as sol inner join Detalle_Solicitud as det on sol.Cod_Solicitud = det.Cod_Solicitud    
                      inner join Subdetalle_Solicitud as sub on sub.Cod_Detalle_Solicitud = det.Cod_Detalle_Solicitud 
					  inner join Solicitud_Cupon as cup on cup.Cod_Detalle_Solicitud = sub.Cod_Detalle_Solicitud
					  where sub.Cod_plu = 361 
					        and sol.Cod_Cadena = 10


****************************************
C:\laragon\www\1sir\receta\receta\receta\precioplu_receta.php

C:\laragon\www\1sir\clases\clase_adminreceta.php

C:\laragon\www\1sir\receta\receta\detalle_plu_receta.php
C:\laragon\www\1sir\js\ajax_adminreceta.js
C:\laragon\www\1sir\clases\clase_adminreceta.php
C:\laragon\www\1sir\receta\receta\precioplu_receta.php
C:\laragon\www\1sir\receta\receta\modifica_receta.php
C:\laragon\www\1sir\receta\receta\detalle_mod_plu_receta.php
C:\laragon\www\1sir\receta\receta\ubicacion_receta.php


*************************************************
select distinct sol.Cod_Solicitud,sol.estado,sol.fecha_Vigencia,sub.Cod_Detalle_Solicitud,sub.Cod_plu 
From Solicitud as sol inner join Detalle_Solicitud as det on sol.Cod_Solicitud = det.Cod_Solicitud    
                      inner join Subdetalle_Solicitud as sub on sub.Cod_Detalle_Solicitud = det.Cod_Detalle_Solicitud 
					  inner join Solicitud_Cupon as cup on cup.Cod_Detalle_Solicitud = sub.Cod_Detalle_Solicitud
					  where sub.Cod_plu = 361 
					        and sol.Cod_Cadena = 10
							and sol.fecha_Vigencia >  (Select GETDATE())
							and det.Estado = 1
							and cup.Estado = 1
***************************************************
ajax.send("opcion="+opcion+"&codplu="+codplu+"&param="+lc_parametro.value);							
var lc_plu_cupon_activo = document.getElementById("plu_cupon_activo").value; 
ajax.send("opcion="+lc_opcion+"&codplu="+lc_codplu+"&codcadena="+lc_codcadena.value+"&plu_cupon_activo="+lc_plu_cupon_activo);

*********************************************
SUPER COMBO(A+M) (1 PRESA) / ENSALADA
***SUPER COMBO(A+M) (2 PRESAS) KFC 428 - 46

**********************************************
//mostrar detalle del PLU
                /*var send ={
					opcion : "plu_en_cupon_activo",
					codplu : lc_codplu.value,
					param : lc_codcadena
					
				};
				$.ajax({
					type: "POST",
					url: "detalle_mod_plu_receta.php",
					data: send,
					async: false,
					success: function (data) {
						document.getElementById("plu_cupon_activo").value = data;
					}
				});*/
				

else if($lc_opcion=='plu_en_cupon_activo'){
 
	$lc_condiciones[0]=$lc_codplu;
	$lc_condiciones[1]=$lc_param;
 
	$obj_cupon_activo = new receta();
	$cupones = "0";
	$i = 0;
	if($obj_cupon_activo->fn_armarquery('plu_en_cupon_activo',$lc_condiciones)){
		
		while($lc_rows = $obj_cupon_activo->fn_leerObjeto())
		{
			$cupones = $lc_rows->Cod_Solicitud .",";
			$i++;
		}
	}
	if($i > 0)
	   $cupones = substr($cupones, 0, -1);
	echo $cupones;				

}				
**************************************************************MID SWT ********************************
C:\laragon\www\1sir\cajas\reportes\conciliacion\relacion_conciliacion.php
C:\laragon\www\1sir\js\ajax_relacion.js
C:\laragon\www\1sir\cajas\reportes\conciliacion\reporte_conciliacionMOD.php
C:\laragon\www\1sir\clases\clase_conciliacion.php
SET NOCOUNT ON; set dateformat dmy set nocount on; exec spConciliacionBancariaTotal 40,'08/02/2021','28/02/2021',10402
select * from DinTrans as dt WHERE dt.cod_restaurante=40 and dt.fecha between '08/02/2021' and '28/02/2021' // de aqui suma los valores de las tarjetas



select * from MIDs_restaurante where Cod_Restaurante = 40
select * from ST_Transaccional 

ALTER PROCEDURE [dbo].[SWT_cargar_mids_datafast] // aqui consulta en la tabla MIDs_Restaurante 
ALTER PROCEDURE [dbo].[SWT_guardar_transaccion_datafast] // guarda en la tabla [ST_Transaccional]

[dbo].[SWT_IAE_Mids_Restaurante] // SP creado para crear MID

SELECT * FROM [TARJETASV3].[BD_ENGINE_KFC].[dbo].[TB_COMERCIO_ADQUIRENTE]

declare @search varchar(50)
SET @search = 'SWT_guardar_transaccion_datafast'

select ROUTINE_NAME, ROUTINE_DEFINITION FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_DEFINITION LIKE '%' + @search + '%' AND ROUTINE_TYPE = 'PROCEDURE' ORDER BY ROUTINE_NAME

var send = {
        opcion = "mid_swt",
        restaurante : lc_restaurante
    };
    $.ajax({
        async: false,
        type: "POST",
        contentType: "application/x-www-form-urlencoded",
        url: "mid_swt.php",
        data: send,
        success: function (data) {
            alert(data);
            if(data === "0")
              alert("No se encontro el MID creado, se procedio a crearlo.");
        }
    });
		

case 'conciliacion_bancaria_mid_swt':
			$lc_query= "select MID from MIDs_restaurante where Cod_Restaurante=$lc_condicion[0] and Estado = 1";
        return $this->fn_ejecutarquery($lc_query);
		   break;			
*************************************************************
select * from MIDs_restaurante where Cod_Restaurante = 40
select * from ST_Transaccional
select * from MIDs_restaurante where Cod_Restaurante=744 and Estado = 1
SELECT * FROM Red_pagos WHERE descripcion = 'DataFast' and Estado = 1

SELECT @cod_nemonico_red = cod_nemonico_red FROM [TARJETASV3].[BD_ENGINE_KFC].[dbo].[TB_COMERCIO_ADQUIRENTE] WITH (NOLOCK) WHERE mid_cadena = @SwitchT and @id_adquirente = @id_adquirente

EXEC SWT_IAE_Mids_Restaurante 40

declare @search varchar(50)
SET @search = 'SWT_guardar_transaccion_datafast'

select ROUTINE_NAME, ROUTINE_DEFINITION FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_DEFINITION LIKE '%' + @search + '%' AND ROUTINE_TYPE = 'PROCEDURE' ORDER BY ROUTINE_NAME

delete from MIDs_restaurante where MID = '2000026002'

INSERT INTO [dbo].[MIDs_restaurante] 
					(
					[MID]
					, [Cod_Red_Pagos]
			        , [Cod_Restaurante]
			        , [Estado]
			        , [Usuario]
			        , [Clave]
					)
					VALUES
					(
					  '832345'
			        , 2
					, 40
			        , 1
			        , null
			        , null
					);
select * from MIDs_restaurante where Cod_Restaurante = 40
select * from ST_Transaccional
SELECT * FROM Red_pagos WHERE descripcion = 'DataFast' and Estado = 1
SELECT SwitchT FROM Restaurante WITH(NOLOCK) where Cod_Restaurante = 40

SELECT @cod_nemonico_red = cod_nemonico_red FROM [TARJETASV3].[BD_ENGINE_KFC].[dbo].[TB_COMERCIO_ADQUIRENTE] WITH (NOLOCK) WHERE mid_cadena = '000000kfc004' and id_adquirente = 'DATAFAST'

EXEC SWT_IAE_Mids_Restaurante 40

declare @search varchar(50)
SET @search = 'Audit'

select ROUTINE_NAME, ROUTINE_DEFINITION FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_DEFINITION LIKE '%' + @search + '%' AND ROUTINE_TYPE = 'PROCEDURE' ORDER BY ROUTINE_NAME

delete from MIDs_restaurante where MID = '2000026002'

DECLARE  @cod_nemonico_red	VARCHAR(50)
			,@Cod_Red_Pagos INT
			,@SwitchT	VARCHAR(50) 
			,@mid_cadena VARCHAR(50)
			,@id_adquirente VARCHAR(100)

			SELECT @cod_nemonico_red = cod_nemonico_red FROM [TARJETASV3].[BD_ENGINE_KFC].[dbo].[TB_COMERCIO_ADQUIRENTE] WITH (NOLOCK) WHERE mid_cadena = '000000kfc004' and id_adquirente = 'DATAFAST'
			SELECT @cod_nemonico_red

select * from AuditTrans order by 4 desc	
***********para pruebas ************
select * from MIDs_restaurante where Cod_Restaurante = 40	
delete from MIDs_restaurante where MID = '2000026002'

select * from AuditTrans order by 4 desc
EXEC SWT_IAE_Mids_Restaurante 40

*******************Resporte Conciliacion Bancaria ************
archivos:
C:\laragon\www\1sir\js\ajax_relacion.js // modificado la linea 77 a 91
C:\laragon\www\1sir\cajas\reportes\conciliacion\mids_Restaurante.php // archivo nuevo
C:\laragon\www\1sir\clases\clase_midsRestaurante.php // archivo nuevo

*******************Resporte Switch ************
archivos:
C:\laragon\www\1sir\js\ajax_switcht.js
javascrpt
https://www.youtube.com/watch?v=2SetvwBV-SU&list=PLvq-jIkSeTUZ6QgYYO3MwG9EMqC-KoLXA

https://docs.google.com/spreadsheets/d/1-FzSLp0UkN7KFF4g2NqjRWPpfH4M0ccR/edit#gid=172975239
*****************************Reportes para productos cashlesss***************
•	[dbo].[ spConciliacionBancariaTotal]
C:\laragon\www\1sir\cajas\reportes\excel_relacion.php
C:\laragon\www\1sir\cajas\reportes\pdf_relacion.php
C:\laragon\www\1sir\cajas\reportes\reporte_relacion.php
C:\laragon\www\1sir\cajas\reportes\conciliacion\reporte_conciliacionMOD.php
C:\laragon\www\1sir\clases\clase_cierre.php
****************************Resporte conciliacion bancaria CASHLESS ****************
--cabecera
								select t.Cabecera,t.Orden_Cabecera,Count(*) Num from ConciliacionCabecera t
								inner join ConciliacionSubcabecera d on d.Cod_Cabecera=t.Cod_Cabecera
								where d.Cod_Cadena=10
								group by t.Cabecera,t.Orden_Cabecera
								order by t.Orden_Cabecera

select * from ConciliacionCabecera
--subcabecera
select t.Subcabecera,
								t.Orden_Cabecera,t.Orden_subcabecera 
								from ConciliacionCabecera t
								inner join ConciliacionSubcabecera d on d.Cod_Cabecera=t.Cod_Cabecera
								where Cod_Cadena=10
								order by t.Orden_Cabecera,t.Orden_Subcabecera
select * from ConciliacionSubcabecera where Cod_Cadena=10
--valores
SET NOCOUNT ON; set dateformat dmy
			 set nocount on;
			             exec spConciliacionBancariaTotal 744,'04/03/2022','04/03/2022',9571
						 
--modificar el sp spConciliacionBancariaTotal
select * from DinTrans oreder where Cod_Restaurante = 744 and Cod_FormaPago = 1640 order by 11 desc

select * from formaspago where Cod_Cadena=10
set dateformat dmy
select Fecha,[CASHLESS] AS recarga_efectivo 
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE /*fp.cod_tipoF=2 and*/ fp.Nombre in ('CASHLESS') and dt.Cod_Restaurante=744 and dt.Fecha between '07/03/2022' and '07/03/2022'
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([CASHLESS])) piv

-- se crean estas filas 
INSERT  INTO ConciliacionCabecera
                ( Orden_Cabecera ,
                  Cabecera ,
                  Subcabecera ,
                  Orden_Subcabecera 
                )
        VALUES  ( 8 ,
                  'OTROS' ,
                  'cashless' ,
				  13
	            );
INSERT  INTO ConciliacionSubcabecera
                ( Cod_Cabecera ,
                  Cod_Cadena
                )
        VALUES  ( 36 ,
                  10
	            );	
--se modifica el orde para que salga al último el sobrante y diferencias
update ConciliacionCabecera set Orden_Subcabecera = 13 where Cod_Cabecera = 26 
update ConciliacionCabecera set Orden_Subcabecera = 12 where Cod_Cabecera = 36 
				
****************************Resporte relacion de cajas CASHLESS ****************
C:\laragon\www\1sir\cajas\reportes\reporte_relacion.php // modificar para poner la cabecera y subcabecera
C:\laragon\www\1sir\clases\clase_cierre.php //modificar para que no le tome en cuenta cashless en tarjetas
--realcion cajas
select * from DinTrans oreder where Cod_Restaurante = 744 and Cod_FormaPago = 1640 order by 11 desc
--realcin cajas saca los cajeros
set dateformat dmy 
						declare @Fecha datetime
						set @Fecha='07/03/2022'
						select fp.Nombre,dt.*
						from dintrans dt
						inner join formaspago fp on dt.Cod_FormaPago=fp.Cod_FormaPago 
						where fp.Nombre='TOTAL'
						and Cod_Restaurante=744 and fecha=convert(varchar(11),'07/03/2022',103) order by fecha
--reaclacion nombres 
set dateformat dmy
						declare @Fecha datetime
						set @Fecha='07/03/2022'
						select sum(Valor) as Valor,sum(Num_Trans) as Num_Trans
						from dintrans dt
						inner join formaspago fp on dt.Cod_FormaPago=fp.Cod_FormaPago 
						where fp.Nombre='CASHLESS' and Cod_Cajero='MOTTO'
						and Cod_Restaurante=744 and fecha=convert(varchar(11),@Fecha,103)
************************** respaldo inicial del sp *********************
USE [SirSql_Ecu]
GO
/****** Object:  StoredProcedure [dbo].[spConciliacionBancariaTotal]    Script Date: 07/03/2022 15:24:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[spConciliacionBancariaTotal]
(@rest int, @fechaI datetime, @fechaF datetime, @perfil int = null)
as
Begin
	declare @cadena int, @dias int
	declare @columna as varchar(max), @total as varchar(max), @query varchar(max), 
			 @transferencias as varchar(max) = '', @totaltransferencia as varchar(max)='',
			 @fidelizacion as varchar(max)='' , @totalfidelizacion as varchar(max)='',
			 @notaDebCre as varchar(max) = '', @totalnotaDebCre as varchar(max) = '',
			 @totalPropina as varchar(max) = '', @propina as varchar(max) ='';
				   
																	
	set @cadena=(select cod_cadena from Restaurante where Cod_Restaurante=@rest)
--obtengo las fechas y guardo en una tabla temporal
set dateformat dmy
select fecha 
into #tiempo
from timedim where Fecha between @fechaI and @fechaF
--valores de depositos y anticipos
select d.Fecha_Cierre fecha,sum(isnull(ap.Valor_Anticipo,0)) anticipos,max(d.Num_Papeleta) numpapel,sum(d.Efectivo_Banco) efectivo,
sum(d.Monedas_Tevcol) tevcol,sum(isnull(d.Notas_Debito,0))notas_debito,sum(isnull(d.Notas_Credito,0))notas_credito,sum(d.Num_Cheques) num_cheques,sum(d.Valor_Cheques) valor_cheques,((sum(d.Efectivo_Banco)+sum(d.Valor_Cheques)+sum(isnull(d.Notas_Credito,0)))-sum(isnull(d.Notas_Debito,0))) deposito
into #deposito
from Depositos d
left join AnticipoPago ap on d.Cod_Deposito=ap.Cod_Deposito and ap.estado<>0
where d.Cod_Restaurante=@rest and d.Fecha_Cierre between @fechaI and @fechaF and d.estado<>0 
group by d.Fecha_Cierre
--valores de creditos, canjes y cortesias
select Total.Fecha,sum(Total.credito)credito,SUM(Total.canje)canje,SUM(Total.Cortesia_Operaciones)Cortesia_Operaciones,SUM(Total.Cortesia_Mercadeo)Cortesia_Mercadeo 
into #ccc
from (
	select Fecha,isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from(
	select  convert(varchar(11),s.Fecha_Canjeado,103)Fecha,count(s.Cod_Cupon)Cantidad,SUM(Precio)Valor,  tc.Cod_Canje,tc.Descripcion 
	from Solicitud_Cupon s
	inner join Detalle_Solicitud ds on s.Cod_Detalle_Solicitud = ds.Cod_Detalle_Solicitud
	inner join TipoCCC tc on ds.Cod_Canje = tc.Cod_Canje
	where s.Cod_Restaurante=@rest and convert(varchar(11),s.Fecha_Canjeado,103) between @fechaI and @fechaF
	group by tc.Cod_Canje,tc.Descripcion,convert(varchar(11),s.Fecha_Canjeado,103))a
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
	 union all
	select Fecha, isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from (
		  select dt.Fecha,sum(dt.Valor) Valor,tc.Descripcion from DinTrans dt
		  inner join Cupones c on dt.Cod_Cupon=c.Cod_Cupon
		  inner join CuponCliente cc on c.Cod_CuponCliente=cc.Cod_CuponCliente
		  inner join TipoCCC tc on cc.Cod_Canje=tc.Cod_Canje
		  where dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF and dt.Cod_Cupon is not null
		  group by dt.Fecha,tc.Descripcion) t
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
)Total group by Total.Fecha
--valores de retencion
select Fecha,[RETENCION] fuente,[RETENCION_IVA] iva,[TOTAL] total,[CUENTAS COBRAR] cxc,[CAJA CHICA OTROS] cchicaotro,[CORTESIAS]  
into #retencion
from (      
      SELECT dt.Fecha, fp.Nombre descripcion,sum(dt.valor) Valor
      FROM formaspago fp
      LEFT JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=4 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF --and fp.nombre like 'Retencion%'
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR descripcion in ([RETENCION], [RETENCION_IVA],[TOTAL],[CUENTAS COBRAR],[CAJA CHICA OTROS],[CORTESIAS])) piv
--valor de las tarjetas de credito
SELECT dt.Fecha,sum(dt.valor) valor_tarjeta,SUM(dt.Num_Trans) num_tarjeta
into #tarjeta
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE fp.Cod_TipoF=1 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre<>'TOTAL'
GROUP BY  dt.Fecha
--valor de las cajas chicas
SELECT dt.Fecha,sum(cc.Total) valor_cchica 
into #cajachica
FROM dbo.DinTrans dt 
LEFT JOIN dbo.CierreChica cc ON cc.Cod_CierreChica=dt.Num_CajaChica
WHERE dt.Num_CajaChica IS NOT NULL and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
group by dt.Fecha
--creditos sin cupones
select dt.Fecha,sum(dt.Valor) credito_sc 
into #csc
from DinTrans dt 
where dt.Cod_Cliente is not null and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF
group by dt.Fecha
--cupones prepagados - multimarca
SELECT dt.Fecha,sum(dt.valor) cuponPrepagado
into #cuponesPrepagados
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre = 'CUPON PREPAGADO'
GROUP BY  dt.Fecha
--otros
set dateformat dmy
select Fecha,[DESCUENTOS] descuentos,[DESCUENTOS PIXEL] descuento_pixel,[CREDITO NOE] credito_noe,[CORTESIA NOE] cortesia_noe,[PROPINA],[COMISION PROPINA] comision_propina,[TRANSFER BR - CN] transferencia
into #otros
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=2 and fp.Nombre not in ('efectivo','AUTOCONSUMOSS') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([DESCUENTOS],[DESCUENTOS PIXEL], [CREDITO NOE],[CORTESIA NOE],[PROPINA],[COMISION PROPINA],[TRANSFER BR - CN])) piv
--fidelizacion
set dateformat dmy
select Fecha,[RECARGA EFECTIVO] AS recarga_efectivo,[CONSUMO RECARGA] AS consumo_recarga  
into #otros_fidelizacion
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE /*fp.cod_tipoF=2 and*/ fp.Nombre in ('RECARGA EFECTIVO','CONSUMO RECARGA') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([RECARGA EFECTIVO],[CONSUMO RECARGA])) piv

--armar el query final

select convert(varchar(12),ti.fecha,103) fecha,
isnull(re.total,0)+isnull(ccc.credito,0)+isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+ISNULL(Cortesia_Mercadeo,0) total,
isnull(de.anticipos,0)anticipo,
isnull(re.fuente,0)fuente, 
isnull(re.iva,0)iva, 
isnull(de.numpapel,0)numpapel, 
isnull(de.efectivo,0)efectivo, 
isnull(de.tevcol,0)tevcol,
isnull(de.notas_debito,0)notas_debito,
isnull(de.notas_credito,0)notas_credito,
isnull(de.num_cheques,0)num_cheque, 
isnull(de.valor_cheques,0)valor_cheque, 
isnull(de.deposito,0)deposito, 
isnull(ta.num_tarjeta,0)num_tarjeta,
isnull(ta.valor_tarjeta,0)valor_tarjeta,
isnull(cc.valor_cchica,0)cchica, 
isnull(ccc.canje,0)canje, 
isnull(ccc.Cortesia_Operaciones,0)cortesia, 
isnull(ccc.credito,0)credito, 
isnull(ccc.Cortesia_Mercadeo,0)Cortesia_mark,
isnull(re.cchicaotro,0)cchicaotro,
isnull(re.cortesias,0)cortesias, 
isnull(re.cxc,0)cxc, 
isnull(csc.credito_sc,0)credito_sc,
isnull(otfi.recarga_efectivo, 0) AS recarga_efectivo,
isnull(otfi.consumo_recarga, 0) AS consumo_recarga,
(isnull(ot.descuentos,0)+isnull(ot.descuento_pixel,0))descuentos,  
isnull(ot.transferencia, 0) transferencia,
	CASE(select COUNT(*) from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE in ('CREDITO NOE')) when 0 then 0.001 else round(isnull(ot.credito_noe,0),2) end credito_noe,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE IN ('CORTESIA NOE')) when 0 then 0.001 else round(isnull(ot.cortesia_noe,0),2)end cortesia_noe,
	case(select COUNT(*) from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('PROPINA'))when 0 then 0.001 else  round(isnull(ot.propina,0),2)end propina,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('COMISION PROPINA'))when 0 then 0.001 else round(isnull(ot.comision_propina,0),2)end comision_propina, round(isnull(cp.cuponPrepagado,0),2) cuponesPrepagado,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('TRANSFER BR - CN'))when 0 then 0.001 else round(isnull(ot.transferencia,0),2)end tranferencia,
(
	 isnull(ta.valor_tarjeta,0)
    +isnull(cc.valor_cchica,0)
    +isnull(ccc.canje,0) 
    +isnull(ccc.Cortesia_Operaciones,0)  
    +isnull(ccc.credito,0)
    +isnull(ccc.Cortesia_Mercadeo,0)
	+isnull(otfi.recarga_efectivo,0)
	+isnull(otfi.consumo_recarga,0)
    +isnull(re.cchicaotro,0)
    +isnull(re.cortesias,0)
    +isnull(re.cxc,0)
    +isnull(csc.credito_sc,0)  
    +isnull(re.fuente,0)
	---isnull(de.notas_debito,0)
	--+isnull(de.notas_credito,0)
	--+isnull(ot.descuentos,0)
	+isnull(ot.transferencia, 0) 
	+ISNULL(cp.cuponPrepagado, 0)
    +isnull(re.iva,0))+isnull(de.deposito,0)-(isnull(re.total,0)+isnull(ccc.credito,0)+
	isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+isnull(ccc.Cortesia_Mercadeo,0)
	)sobrante

	
into #TotalConsiliacion    
from #tiempo ti
left join #deposito de on ti.fecha=de.fecha
left join #retencion re on ti.fecha=re.fecha
left join #tarjeta ta on ti.fecha=ta.fecha
left join #cajachica cc on ti.fecha=cc.fecha
left join #ccc ccc on ti.fecha=ccc.fecha
left join #csc csc on ti.fecha=csc.fecha
left join #otros ot on ti.fecha=ot.fecha
LEFT JOIN #cuponesPrepagados AS cp ON cp.Fecha = ti.Fecha
LEFT JOIN #otros_fidelizacion AS otfi ON ti.Fecha = otfi.Fecha
order by ti.fecha 


set @dias = (select count(Fecha) from #TotalConsiliacion)
--print @dias

	if exists (select Valor 
				from ConfiguracionXPais
				where Configuracion ='TRANS BR-CN BASKINS' and Estado=1 and Valor = @cadena )
	  BEGIN 
			SET @transferencias = 'round(tranferencia,2)transferencia,'	
			SET @totaltransferencia = 'sum(transferencia) transferencia,'
		
	END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='FIDELIZACION' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @fidelizacion = 'ROUND(recarga_efectivo,2)recarga_efectivo,ROUND(consumo_recarga,2)consumo_recarga,'	
			SET @totalfidelizacion = 'SUM(recarga_efectivo)recarga_efectivo,SUM(consumo_recarga)consumo_recarga,'	

   END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='PROPINA' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @propina = 'case when propina =0.001 then 0.001 else round(propina,2) end propina,
case when comision_propina=0.001 then 0.001 else round(comision_propina,2) end comision_propina, '	
			SET @totalPropina = 'case when avg(distinct propina) = 0.001 then 0.001 else SUM(propina) end propina, 
case when avg(distinct comision_propina) = 0.001 then 0.001 else SUM(comision_propina) end comision_propina, '	

   END  
  -- if exists ( SELECT cp.Valor
  --             FROM Perfil p
  --             INNER JOIN (SELECT top(1) Valor 
		--                   FROM ConfiguracionXPais 
  --                         WHERE Configuracion = 'Perfil') cp on p.Nombre like cp.Valor+' %'  COLLATE Modern_Spanish_CI_AS  
  --            INNER JOIN Users usr on p.Cod_Perfil = usr.Cod_Perfil
  --            WHERE Cod_Usuario = @perfil)
		--BEGIN 
			SET @notaDebCre = 'notas_debito,notas_credito,'	
			SET @totalnotaDebCre = 'SUM(notas_debito)notas_debito,SUM(notas_credito)notas_credito,'
		--END


	set @columna = 'Fecha,round(total,2)total,round(anticipo,2)anticipo,round(fuente,2)fuente,round(iva,2)iva,numpapel,round(efectivo,2)efectivo,round(tevcol,2)tevcol,'+@notaDebCre+'round(num_cheque,2)num_cheque,round(valor_cheque,2)valor_cheque,round(deposito,2)deposito,
							num_tarjeta,round(valor_tarjeta,2)valor_tarjeta,round(cchica,2)cchica,round(canje,2)canje,
							round(cortesia,2)cortesia,round(credito,2)credito,round(Cortesia_mark,2)Cortesia_mark,'+@fidelizacion+'
							round(cchicaotro,2)cchicaotro,round(cortesias,2)cortesias,round(cxc,2)cxc,round(credito_sc,2)credito_sc, round(descuentos,2)descuentos, '+@propina+'round(cuponesPrepagado,2)cuponesPrepagado,'+@transferencias+'ROUND(sobrante,2)sobrante';
	SET @total = '''Total'' Fecha, SUM(total)total,SUM(anticipo)anticipo,SUM(fuente)fuente,SUM(iva)iva, ''--------'' numpapel,SUM(efectivo)efectivo,SUM(tevcol)tevcol,'+@totalnotaDebCre+'
							SUM(num_cheque)num_cheque,SUM(valor_cheque)valor_cheque,SUM(deposito)deposito, SUM(num_tarjeta)num_tarjeta,SUM(valor_tarjeta)valor_tarjeta,SUM(cchica)cchica,
							SUM(canje)canje,SUM(cortesia)cortesia,SUM(credito)credito,SUM(Cortesia_mark)Cortesia_mark,'+@totalfidelizacion+'
							SUM(cchicaotro)cchicaotro,SUM(cortesias)cortesias,SUM(cxc)cxc,SUM(credito_sc)credito_sc, SUM(descuentos)descuentos,'+@totalPropina+'SUM(cuponesPrepagado )cuponesPrepagado,'+@totaltransferencia+'
							SUM(sobrante)sobrante'


				set @query = '
								select '+@columna+' 
								from #TotalConsiliacion 
								union
								select '+@total+'
								FROM #TotalConsiliacion'

exec (@query)


--end

drop table #tiempo,#retencion, #ccc,#deposito,#tarjeta, #cajachica,#csc,#otros,#TotalConsiliacion --,#sf
end
*************************************		
************************************sp cpn los cambios*****************
USE [SirSql_Ecu]
GO
/****** Object:  StoredProcedure [dbo].[spConciliacionBancariaTotal]    Script Date: 07/03/2022 15:24:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[spConciliacionBancariaTotal]
(@rest int, @fechaI datetime, @fechaF datetime, @perfil int = null)
as
Begin
	declare @cadena int, @dias int
	declare @columna as varchar(max), @total as varchar(max), @query varchar(max), 
			 @transferencias as varchar(max) = '', @totaltransferencia as varchar(max)='',
			 @fidelizacion as varchar(max)='' , @totalfidelizacion as varchar(max)='',
			 @notaDebCre as varchar(max) = '', @totalnotaDebCre as varchar(max) = '',
			 @totalPropina as varchar(max) = '', @propina as varchar(max) ='';
				   
																	
	set @cadena=(select cod_cadena from Restaurante where Cod_Restaurante=@rest)
--obtengo las fechas y guardo en una tabla temporal
set dateformat dmy
select fecha 
into #tiempo
from timedim where Fecha between @fechaI and @fechaF
--valores de depositos y anticipos
select d.Fecha_Cierre fecha,sum(isnull(ap.Valor_Anticipo,0)) anticipos,max(d.Num_Papeleta) numpapel,sum(d.Efectivo_Banco) efectivo,
sum(d.Monedas_Tevcol) tevcol,sum(isnull(d.Notas_Debito,0))notas_debito,sum(isnull(d.Notas_Credito,0))notas_credito,sum(d.Num_Cheques) num_cheques,sum(d.Valor_Cheques) valor_cheques,((sum(d.Efectivo_Banco)+sum(d.Valor_Cheques)+sum(isnull(d.Notas_Credito,0)))-sum(isnull(d.Notas_Debito,0))) deposito
into #deposito
from Depositos d
left join AnticipoPago ap on d.Cod_Deposito=ap.Cod_Deposito and ap.estado<>0
where d.Cod_Restaurante=@rest and d.Fecha_Cierre between @fechaI and @fechaF and d.estado<>0 
group by d.Fecha_Cierre
--valores de creditos, canjes y cortesias
select Total.Fecha,sum(Total.credito)credito,SUM(Total.canje)canje,SUM(Total.Cortesia_Operaciones)Cortesia_Operaciones,SUM(Total.Cortesia_Mercadeo)Cortesia_Mercadeo 
into #ccc
from (
	select Fecha,isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from(
	select  convert(varchar(11),s.Fecha_Canjeado,103)Fecha,count(s.Cod_Cupon)Cantidad,SUM(Precio)Valor,  tc.Cod_Canje,tc.Descripcion 
	from Solicitud_Cupon s
	inner join Detalle_Solicitud ds on s.Cod_Detalle_Solicitud = ds.Cod_Detalle_Solicitud
	inner join TipoCCC tc on ds.Cod_Canje = tc.Cod_Canje
	where s.Cod_Restaurante=@rest and convert(varchar(11),s.Fecha_Canjeado,103) between @fechaI and @fechaF
	group by tc.Cod_Canje,tc.Descripcion,convert(varchar(11),s.Fecha_Canjeado,103))a
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
	 union all
	select Fecha, isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from (
		  select dt.Fecha,sum(dt.Valor) Valor,tc.Descripcion from DinTrans dt
		  inner join Cupones c on dt.Cod_Cupon=c.Cod_Cupon
		  inner join CuponCliente cc on c.Cod_CuponCliente=cc.Cod_CuponCliente
		  inner join TipoCCC tc on cc.Cod_Canje=tc.Cod_Canje
		  where dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF and dt.Cod_Cupon is not null
		  group by dt.Fecha,tc.Descripcion) t
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
)Total group by Total.Fecha
--valores de retencion
select Fecha,[RETENCION] fuente,[RETENCION_IVA] iva,[TOTAL] total,[CUENTAS COBRAR] cxc,[CAJA CHICA OTROS] cchicaotro,[CORTESIAS]  
into #retencion
from (      
      SELECT dt.Fecha, fp.Nombre descripcion,sum(dt.valor) Valor
      FROM formaspago fp
      LEFT JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=4 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF --and fp.nombre like 'Retencion%'
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR descripcion in ([RETENCION], [RETENCION_IVA],[TOTAL],[CUENTAS COBRAR],[CAJA CHICA OTROS],[CORTESIAS])) piv
--valor de las tarjetas de credito
SELECT dt.Fecha,sum(dt.valor) valor_tarjeta,SUM(dt.Num_Trans) num_tarjeta
into #tarjeta
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE fp.Cod_TipoF=1 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre<>'TOTAL'
GROUP BY  dt.Fecha
--valor de las cajas chicas
SELECT dt.Fecha,sum(cc.Total) valor_cchica 
into #cajachica
FROM dbo.DinTrans dt 
LEFT JOIN dbo.CierreChica cc ON cc.Cod_CierreChica=dt.Num_CajaChica
WHERE dt.Num_CajaChica IS NOT NULL and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
group by dt.Fecha
--creditos sin cupones
select dt.Fecha,sum(dt.Valor) credito_sc 
into #csc
from DinTrans dt 
where dt.Cod_Cliente is not null and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF
group by dt.Fecha
--cupones prepagados - multimarca
SELECT dt.Fecha,sum(dt.valor) cuponPrepagado
into #cuponesPrepagados
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre = 'CUPON PREPAGADO'
GROUP BY  dt.Fecha
--otros
set dateformat dmy
select Fecha,[DESCUENTOS] descuentos,[DESCUENTOS PIXEL] descuento_pixel,[CREDITO NOE] credito_noe,[CORTESIA NOE] cortesia_noe,[PROPINA],[COMISION PROPINA] comision_propina,[TRANSFER BR - CN] transferencia
into #otros
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=2 and fp.Nombre not in ('efectivo','AUTOCONSUMOSS') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([DESCUENTOS],[DESCUENTOS PIXEL], [CREDITO NOE],[CORTESIA NOE],[PROPINA],[COMISION PROPINA],[TRANSFER BR - CN])) piv
--fidelizacion
set dateformat dmy
select Fecha,[RECARGA EFECTIVO] AS recarga_efectivo,[CONSUMO RECARGA] AS consumo_recarga  
into #otros_fidelizacion
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE /*fp.cod_tipoF=2 and*/ fp.Nombre in ('RECARGA EFECTIVO','CONSUMO RECARGA') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([RECARGA EFECTIVO],[CONSUMO RECARGA])) piv
--cupones prepagados - multimarca
SELECT dt.Fecha,sum(dt.valor) cashless
into #otros_cashless
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre = 'CASHLESS'
GROUP BY  dt.Fecha
--armar el query final

select convert(varchar(12),ti.fecha,103) fecha,
isnull(re.total,0)+isnull(ccc.credito,0)+isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+ISNULL(Cortesia_Mercadeo,0) total,
isnull(de.anticipos,0)anticipo,
isnull(re.fuente,0)fuente, 
isnull(re.iva,0)iva, 
isnull(de.numpapel,0)numpapel, 
isnull(de.efectivo,0)efectivo, 
isnull(de.tevcol,0)tevcol,
isnull(de.notas_debito,0)notas_debito,
isnull(de.notas_credito,0)notas_credito,
isnull(de.num_cheques,0)num_cheque, 
isnull(de.valor_cheques,0)valor_cheque, 
isnull(de.deposito,0)deposito, 
isnull(ta.num_tarjeta,0)num_tarjeta,
isnull(ta.valor_tarjeta,0)valor_tarjeta,
isnull(cc.valor_cchica,0)cchica, 
isnull(ccc.canje,0)canje, 
isnull(ccc.Cortesia_Operaciones,0)cortesia, 
isnull(ccc.credito,0)credito, 
isnull(ccc.Cortesia_Mercadeo,0)Cortesia_mark,
isnull(re.cchicaotro,0)cchicaotro,
isnull(re.cortesias,0)cortesias, 
isnull(re.cxc,0)cxc, 
isnull(csc.credito_sc,0)credito_sc,
isnull(otfi.recarga_efectivo, 0) AS recarga_efectivo,
isnull(otfi.consumo_recarga, 0) AS consumo_recarga,
isnull(otca.cashless, 0) AS cashless,
(isnull(ot.descuentos,0)+isnull(ot.descuento_pixel,0))descuentos,  
isnull(ot.transferencia, 0) transferencia,
	CASE(select COUNT(*) from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE in ('CREDITO NOE')) when 0 then 0.001 else round(isnull(ot.credito_noe,0),2) end credito_noe,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE IN ('CORTESIA NOE')) when 0 then 0.001 else round(isnull(ot.cortesia_noe,0),2)end cortesia_noe,
	case(select COUNT(*) from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('PROPINA'))when 0 then 0.001 else  round(isnull(ot.propina,0),2)end propina,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('COMISION PROPINA'))when 0 then 0.001 else round(isnull(ot.comision_propina,0),2)end comision_propina, round(isnull(cp.cuponPrepagado,0),2) cuponesPrepagado,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('TRANSFER BR - CN'))when 0 then 0.001 else round(isnull(ot.transferencia,0),2)end tranferencia,
(
	 isnull(ta.valor_tarjeta,0)
    +isnull(cc.valor_cchica,0)
    +isnull(ccc.canje,0) 
    +isnull(ccc.Cortesia_Operaciones,0)  
    +isnull(ccc.credito,0)
    +isnull(ccc.Cortesia_Mercadeo,0)
	+isnull(otfi.recarga_efectivo,0)
	+isnull(otfi.consumo_recarga,0)
    +isnull(re.cchicaotro,0)
    +isnull(re.cortesias,0)
    +isnull(re.cxc,0)
    +isnull(csc.credito_sc,0)  
    +isnull(re.fuente,0)
	---isnull(de.notas_debito,0)
	--+isnull(de.notas_credito,0)
	--+isnull(ot.descuentos,0)
	+isnull(ot.transferencia, 0) 
	+ISNULL(cp.cuponPrepagado, 0)
    +isnull(re.iva,0))+isnull(de.deposito,0)-(isnull(re.total,0)+isnull(ccc.credito,0)+
	isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+isnull(ccc.Cortesia_Mercadeo,0)
	)sobrante

	
into #TotalConsiliacion    
from #tiempo ti
left join #deposito de on ti.fecha=de.fecha
left join #retencion re on ti.fecha=re.fecha
left join #tarjeta ta on ti.fecha=ta.fecha
left join #cajachica cc on ti.fecha=cc.fecha
left join #ccc ccc on ti.fecha=ccc.fecha
left join #csc csc on ti.fecha=csc.fecha
left join #otros ot on ti.fecha=ot.fecha
LEFT JOIN #cuponesPrepagados AS cp ON cp.Fecha = ti.Fecha
LEFT JOIN #otros_fidelizacion AS otfi ON ti.Fecha = otfi.Fecha
LEFT JOIN #otros_cashless AS otca ON ti.Fecha = otca.Fecha
order by ti.fecha 


set @dias = (select count(Fecha) from #TotalConsiliacion)
--print @dias

	if exists (select Valor 
				from ConfiguracionXPais
				where Configuracion ='TRANS BR-CN BASKINS' and Estado=1 and Valor = @cadena )
	  BEGIN 
			SET @transferencias = 'round(tranferencia,2)transferencia,'	
			SET @totaltransferencia = 'sum(transferencia) transferencia,'
		
	END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='FIDELIZACION' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @fidelizacion = 'ROUND(recarga_efectivo,2)recarga_efectivo,ROUND(consumo_recarga,2)consumo_recarga,'	
			SET @totalfidelizacion = 'SUM(recarga_efectivo)recarga_efectivo,SUM(consumo_recarga)consumo_recarga,'	

   END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='PROPINA' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @propina = 'case when propina =0.001 then 0.001 else round(propina,2) end propina,
case when comision_propina=0.001 then 0.001 else round(comision_propina,2) end comision_propina, '	
			SET @totalPropina = 'case when avg(distinct propina) = 0.001 then 0.001 else SUM(propina) end propina, 
case when avg(distinct comision_propina) = 0.001 then 0.001 else SUM(comision_propina) end comision_propina, '	

   END  
  -- if exists ( SELECT cp.Valor
  --             FROM Perfil p
  --             INNER JOIN (SELECT top(1) Valor 
		--                   FROM ConfiguracionXPais 
  --                         WHERE Configuracion = 'Perfil') cp on p.Nombre like cp.Valor+' %'  COLLATE Modern_Spanish_CI_AS  
  --            INNER JOIN Users usr on p.Cod_Perfil = usr.Cod_Perfil
  --            WHERE Cod_Usuario = @perfil)
		--BEGIN 
			SET @notaDebCre = 'notas_debito,notas_credito,'	
			SET @totalnotaDebCre = 'SUM(notas_debito)notas_debito,SUM(notas_credito)notas_credito,'
		--END


	set @columna = 'Fecha,round(total,2)total,round(anticipo,2)anticipo,round(fuente,2)fuente,round(iva,2)iva,numpapel,round(efectivo,2)efectivo,round(tevcol,2)tevcol,'+@notaDebCre+'round(num_cheque,2)num_cheque,round(valor_cheque,2)valor_cheque,round(deposito,2)deposito,
							num_tarjeta,round(valor_tarjeta,2)valor_tarjeta,round(cchica,2)cchica,round(canje,2)canje,
							round(cortesia,2)cortesia,round(credito,2)credito,round(Cortesia_mark,2)Cortesia_mark,'+@fidelizacion+'
							round(cchicaotro,2)cchicaotro,round(cortesias,2)cortesias,round(cxc,2)cxc,round(credito_sc,2)credito_sc, round(descuentos,2)descuentos, '+@propina+'round(cuponesPrepagado,2)cuponesPrepagado,'+@transferencias+'ROUND(sobrante,2)sobrante';
	SET @total = '''Total'' Fecha, SUM(total)total,SUM(anticipo)anticipo,SUM(fuente)fuente,SUM(iva)iva, ''--------'' numpapel,SUM(efectivo)efectivo,SUM(tevcol)tevcol,'+@totalnotaDebCre+'
							SUM(num_cheque)num_cheque,SUM(valor_cheque)valor_cheque,SUM(deposito)deposito, SUM(num_tarjeta)num_tarjeta,SUM(valor_tarjeta)valor_tarjeta,SUM(cchica)cchica,
							SUM(canje)canje,SUM(cortesia)cortesia,SUM(credito)credito,SUM(Cortesia_mark)Cortesia_mark,'+@totalfidelizacion+'
							SUM(cchicaotro)cchicaotro,SUM(cortesias)cortesias,SUM(cxc)cxc,SUM(credito_sc)credito_sc, SUM(descuentos)descuentos,'+@totalPropina+'SUM(cuponesPrepagado )cuponesPrepagado,'+@totaltransferencia+'
							SUM(sobrante)sobrante'


				set @query = '
								select '+@columna+' 
								from #TotalConsiliacion 
								union
								select '+@total+'
								FROM #TotalConsiliacion'

exec (@query)


--end

drop table #tiempo,#retencion, #ccc,#deposito,#tarjeta, #cajachica,#csc,#otros,#TotalConsiliacion --,#sf
end
				
*************************************** respaldo tabla
ConciliacionCabecera
1	1	ANTICIPO	anticipos	1
2	2	RETENCIONES	fuente	1
3	2	RETENCIONES	iva	2
4	3	DEPOSITOS	papeleta	1
5	3	DEPOSITOS	efectivo	2
6	3	DEPOSITOS	tevcol	3
7	3	DEPOSITOS	num_che	6
8	3	DEPOSITOS	cheques	7
9	3	DEPOSITOS	deposito	8
10	4	TARJETAS	num	1
11	4	TARJETAS	tarjetas	2
12	5	C.CHICA	c.chica	1
13	6	CUPONES	canjes	1
14	6	CUPONES	cortesias	2
15	6	CUPONES	credito	3
16	6	CUPONES	cortesia_m	4
17	8	OTROS	c.chica otros	1
18	8	OTROS	descuent cort	2
19	8	OTROS	CxC	3
20	8	OTROS	credito S/C	4
21	8	OTROS	descuento	5
22	8	OTROS	Cre.Noe	6
23	8	OTROS	Cort.Noe	7
24	8	OTROS	Propina	8
25	8	OTROS	Comi.Propi	9
26	8	OTROS	S / F	12
27	8	OTROS	C_Prepagado	10
28	7	FIDELIZACION	Recarga	1
30	7	FIDELIZACION	Consumo	2
31	8	OTROS	TRANSFER BR - CN	11
32	3	DEPOSITOS	N.Debito	4
33	3	DEPOSITOS	N.Credito	5
36	8	OTROS	cashless	13				

$total_cashless
****************************************
USE [SirSql_Ecu]
GO
/****** Object:  StoredProcedure [dbo].[spConciliacionBancariaTotal]    Script Date: 07/03/2022 15:24:31 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[spConciliacionBancariaTotal]
(@rest int, @fechaI datetime, @fechaF datetime, @perfil int = null)
as
Begin
	declare @cadena int, @dias int
	declare @columna as varchar(max), @total as varchar(max), @query varchar(max), 
			 @transferencias as varchar(max) = '', @totaltransferencia as varchar(max)='',
			 @fidelizacion as varchar(max)='' , @totalfidelizacion as varchar(max)='',
			 @notaDebCre as varchar(max) = '', @totalnotaDebCre as varchar(max) = '',
			 @totalPropina as varchar(max) = '', @propina as varchar(max) ='';
				   
																	
	set @cadena=(select cod_cadena from Restaurante where Cod_Restaurante=@rest)
--obtengo las fechas y guardo en una tabla temporal
set dateformat dmy
select fecha 
into #tiempo
from timedim where Fecha between @fechaI and @fechaF
--valores de depositos y anticipos
select d.Fecha_Cierre fecha,sum(isnull(ap.Valor_Anticipo,0)) anticipos,max(d.Num_Papeleta) numpapel,sum(d.Efectivo_Banco) efectivo,
sum(d.Monedas_Tevcol) tevcol,sum(isnull(d.Notas_Debito,0))notas_debito,sum(isnull(d.Notas_Credito,0))notas_credito,sum(d.Num_Cheques) num_cheques,sum(d.Valor_Cheques) valor_cheques,((sum(d.Efectivo_Banco)+sum(d.Valor_Cheques)+sum(isnull(d.Notas_Credito,0)))-sum(isnull(d.Notas_Debito,0))) deposito
into #deposito
from Depositos d
left join AnticipoPago ap on d.Cod_Deposito=ap.Cod_Deposito and ap.estado<>0
where d.Cod_Restaurante=@rest and d.Fecha_Cierre between @fechaI and @fechaF and d.estado<>0 
group by d.Fecha_Cierre
--valores de creditos, canjes y cortesias
select Total.Fecha,sum(Total.credito)credito,SUM(Total.canje)canje,SUM(Total.Cortesia_Operaciones)Cortesia_Operaciones,SUM(Total.Cortesia_Mercadeo)Cortesia_Mercadeo 
into #ccc
from (
	select Fecha,isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from(
	select  convert(varchar(11),s.Fecha_Canjeado,103)Fecha,count(s.Cod_Cupon)Cantidad,SUM(Precio)Valor,  tc.Cod_Canje,tc.Descripcion 
	from Solicitud_Cupon s
	inner join Detalle_Solicitud ds on s.Cod_Detalle_Solicitud = ds.Cod_Detalle_Solicitud
	inner join TipoCCC tc on ds.Cod_Canje = tc.Cod_Canje
	where s.Cod_Restaurante=@rest and convert(varchar(11),s.Fecha_Canjeado,103) between @fechaI and @fechaF
	group by tc.Cod_Canje,tc.Descripcion,convert(varchar(11),s.Fecha_Canjeado,103))a
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
	 union all
	select Fecha, isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from (
		  select dt.Fecha,sum(dt.Valor) Valor,tc.Descripcion from DinTrans dt
		  inner join Cupones c on dt.Cod_Cupon=c.Cod_Cupon
		  inner join CuponCliente cc on c.Cod_CuponCliente=cc.Cod_CuponCliente
		  inner join TipoCCC tc on cc.Cod_Canje=tc.Cod_Canje
		  where dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF and dt.Cod_Cupon is not null
		  group by dt.Fecha,tc.Descripcion) t
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
)Total group by Total.Fecha
--valores de retencion
select Fecha,[RETENCION] fuente,[RETENCION_IVA] iva,[TOTAL] total,[CUENTAS COBRAR] cxc,[CAJA CHICA OTROS] cchicaotro,[CORTESIAS]  
into #retencion
from (      
      SELECT dt.Fecha, fp.Nombre descripcion,sum(dt.valor) Valor
      FROM formaspago fp
      LEFT JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=4 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF --and fp.nombre like 'Retencion%'
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR descripcion in ([RETENCION], [RETENCION_IVA],[TOTAL],[CUENTAS COBRAR],[CAJA CHICA OTROS],[CORTESIAS])) piv
--valor de las tarjetas de credito
SELECT dt.Fecha,sum(dt.valor) valor_tarjeta,SUM(dt.Num_Trans) num_tarjeta
into #tarjeta
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE fp.Cod_TipoF=1 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre<>'TOTAL'
GROUP BY  dt.Fecha
--valor de las cajas chicas
SELECT dt.Fecha,sum(cc.Total) valor_cchica 
into #cajachica
FROM dbo.DinTrans dt 
LEFT JOIN dbo.CierreChica cc ON cc.Cod_CierreChica=dt.Num_CajaChica
WHERE dt.Num_CajaChica IS NOT NULL and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
group by dt.Fecha
--creditos sin cupones
select dt.Fecha,sum(dt.Valor) credito_sc 
into #csc
from DinTrans dt 
where dt.Cod_Cliente is not null and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF
group by dt.Fecha
--cupones prepagados - multimarca
SELECT dt.Fecha,sum(dt.valor) cuponPrepagado
into #cuponesPrepagados
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre = 'CUPON PREPAGADO'
GROUP BY  dt.Fecha
--otros
set dateformat dmy
select Fecha,[DESCUENTOS] descuentos,[DESCUENTOS PIXEL] descuento_pixel,[CREDITO NOE] credito_noe,[CORTESIA NOE] cortesia_noe,[PROPINA],[COMISION PROPINA] comision_propina,[TRANSFER BR - CN] transferencia
into #otros
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=2 and fp.Nombre not in ('efectivo','AUTOCONSUMOSS') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([DESCUENTOS],[DESCUENTOS PIXEL], [CREDITO NOE],[CORTESIA NOE],[PROPINA],[COMISION PROPINA],[TRANSFER BR - CN])) piv
--fidelizacion
set dateformat dmy
select Fecha,[RECARGA EFECTIVO] AS recarga_efectivo,[CONSUMO RECARGA] AS consumo_recarga  
into #otros_fidelizacion
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE /*fp.cod_tipoF=2 and*/ fp.Nombre in ('RECARGA EFECTIVO','CONSUMO RECARGA') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([RECARGA EFECTIVO],[CONSUMO RECARGA])) piv
--cupones prepagados - multimarca
SELECT dt.Fecha,sum(dt.valor) cashless
into #otros_cashless
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre = 'CASHLESS'
GROUP BY  dt.Fecha
--armar el query final

select convert(varchar(12),ti.fecha,103) fecha,
isnull(re.total,0)+isnull(ccc.credito,0)+isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+ISNULL(Cortesia_Mercadeo,0) total,
isnull(de.anticipos,0)anticipo,
isnull(re.fuente,0)fuente, 
isnull(re.iva,0)iva, 
isnull(de.numpapel,0)numpapel, 
isnull(de.efectivo,0)efectivo, 
isnull(de.tevcol,0)tevcol,
isnull(de.notas_debito,0)notas_debito,
isnull(de.notas_credito,0)notas_credito,
isnull(de.num_cheques,0)num_cheque, 
isnull(de.valor_cheques,0)valor_cheque, 
isnull(de.deposito,0)deposito, 
isnull(ta.num_tarjeta,0)num_tarjeta,
isnull(ta.valor_tarjeta,0)valor_tarjeta,
isnull(cc.valor_cchica,0)cchica, 
isnull(ccc.canje,0)canje, 
isnull(ccc.Cortesia_Operaciones,0)cortesia, 
isnull(ccc.credito,0)credito, 
isnull(ccc.Cortesia_Mercadeo,0)Cortesia_mark,
isnull(re.cchicaotro,0)cchicaotro,
isnull(re.cortesias,0)cortesias, 
isnull(re.cxc,0)cxc, 
isnull(csc.credito_sc,0)credito_sc,
isnull(otfi.recarga_efectivo, 0) AS recarga_efectivo,
isnull(otfi.consumo_recarga, 0) AS consumo_recarga,
isnull(otca.cashless, 0) AS cashless,
(isnull(ot.descuentos,0)+isnull(ot.descuento_pixel,0))descuentos,  
isnull(ot.transferencia, 0) transferencia,
	CASE(select COUNT(*) from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE in ('CREDITO NOE')) when 0 then 0.001 else round(isnull(ot.credito_noe,0),2) end credito_noe,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE IN ('CORTESIA NOE')) when 0 then 0.001 else round(isnull(ot.cortesia_noe,0),2)end cortesia_noe,
	case(select COUNT(*) from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('PROPINA'))when 0 then 0.001 else  round(isnull(ot.propina,0),2)end propina,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('COMISION PROPINA'))when 0 then 0.001 else round(isnull(ot.comision_propina,0),2)end comision_propina, round(isnull(cp.cuponPrepagado,0),2) cuponesPrepagado,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('TRANSFER BR - CN'))when 0 then 0.001 else round(isnull(ot.transferencia,0),2)end tranferencia,
(
	 isnull(ta.valor_tarjeta,0)
    +isnull(cc.valor_cchica,0)
    +isnull(ccc.canje,0) 
    +isnull(ccc.Cortesia_Operaciones,0)  
    +isnull(ccc.credito,0)
    +isnull(ccc.Cortesia_Mercadeo,0)
	+isnull(otfi.recarga_efectivo,0)
	+isnull(otfi.consumo_recarga,0)
    +isnull(re.cchicaotro,0)
    +isnull(re.cortesias,0)
    +isnull(re.cxc,0)
    +isnull(csc.credito_sc,0)  
    +isnull(re.fuente,0)
	---isnull(de.notas_debito,0)
	--+isnull(de.notas_credito,0)
	--+isnull(ot.descuentos,0)
	+isnull(ot.transferencia, 0) 
	+ISNULL(cp.cuponPrepagado, 0)
    +isnull(re.iva,0))+isnull(de.deposito,0)-(isnull(re.total,0)+isnull(ccc.credito,0)+
	isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+isnull(ccc.Cortesia_Mercadeo,0)
	)sobrante

	
into #TotalConsiliacion    
from #tiempo ti
left join #deposito de on ti.fecha=de.fecha
left join #retencion re on ti.fecha=re.fecha
left join #tarjeta ta on ti.fecha=ta.fecha
left join #cajachica cc on ti.fecha=cc.fecha
left join #ccc ccc on ti.fecha=ccc.fecha
left join #csc csc on ti.fecha=csc.fecha
left join #otros ot on ti.fecha=ot.fecha
LEFT JOIN #cuponesPrepagados AS cp ON cp.Fecha = ti.Fecha
LEFT JOIN #otros_fidelizacion AS otfi ON ti.Fecha = otfi.Fecha
LEFT JOIN #otros_cashless AS otca ON ti.Fecha = otca.Fecha
order by ti.fecha 


set @dias = (select count(Fecha) from #TotalConsiliacion)
--print @dias

	if exists (select Valor 
				from ConfiguracionXPais
				where Configuracion ='TRANS BR-CN BASKINS' and Estado=1 and Valor = @cadena )
	  BEGIN 
			SET @transferencias = 'round(tranferencia,2)transferencia,'	
			SET @totaltransferencia = 'sum(transferencia) transferencia,'
		
	END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='FIDELIZACION' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @fidelizacion = 'ROUND(recarga_efectivo,2)recarga_efectivo,ROUND(consumo_recarga,2)consumo_recarga,'	
			SET @totalfidelizacion = 'SUM(recarga_efectivo)recarga_efectivo,SUM(consumo_recarga)consumo_recarga,'	

   END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='PROPINA' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @propina = 'case when propina =0.001 then 0.001 else round(propina,2) end propina,
case when comision_propina=0.001 then 0.001 else round(comision_propina,2) end comision_propina, '	
			SET @totalPropina = 'case when avg(distinct propina) = 0.001 then 0.001 else SUM(propina) end propina, 
case when avg(distinct comision_propina) = 0.001 then 0.001 else SUM(comision_propina) end comision_propina, '	

   END  
  -- if exists ( SELECT cp.Valor
  --             FROM Perfil p
  --             INNER JOIN (SELECT top(1) Valor 
		--                   FROM ConfiguracionXPais 
  --                         WHERE Configuracion = 'Perfil') cp on p.Nombre like cp.Valor+' %'  COLLATE Modern_Spanish_CI_AS  
  --            INNER JOIN Users usr on p.Cod_Perfil = usr.Cod_Perfil
  --            WHERE Cod_Usuario = @perfil)
		--BEGIN 
			SET @notaDebCre = 'notas_debito,notas_credito,'	
			SET @totalnotaDebCre = 'SUM(notas_debito)notas_debito,SUM(notas_credito)notas_credito,'
		--END


	set @columna = 'Fecha,round(total,2)total,round(anticipo,2)anticipo,round(fuente,2)fuente,round(iva,2)iva,numpapel,round(efectivo,2)efectivo,round(tevcol,2)tevcol,'+@notaDebCre+'round(num_cheque,2)num_cheque,round(valor_cheque,2)valor_cheque,round(deposito,2)deposito,
							num_tarjeta,round(valor_tarjeta,2)valor_tarjeta,round(cchica,2)cchica,round(canje,2)canje,
							round(cortesia,2)cortesia,round(credito,2)credito,round(Cortesia_mark,2)Cortesia_mark,'+@fidelizacion+'
							round(cchicaotro,2)cchicaotro,round(cortesias,2)cortesias,round(cxc,2)cxc,round(credito_sc,2)credito_sc, round(descuentos,2)descuentos, '+@propina+'round(cuponesPrepagado,2)cuponesPrepagado,ROUND(cashless,2)cashless,'+@transferencias+'ROUND(sobrante,2)sobrante';
	SET @total = '''Total'' Fecha, SUM(total)total,SUM(anticipo)anticipo,SUM(fuente)fuente,SUM(iva)iva, ''--------'' numpapel,SUM(efectivo)efectivo,SUM(tevcol)tevcol,'+@totalnotaDebCre+'
							SUM(num_cheque)num_cheque,SUM(valor_cheque)valor_cheque,SUM(deposito)deposito, SUM(num_tarjeta)num_tarjeta,SUM(valor_tarjeta)valor_tarjeta,SUM(cchica)cchica,
							SUM(canje)canje,SUM(cortesia)cortesia,SUM(credito)credito,SUM(Cortesia_mark)Cortesia_mark,'+@totalfidelizacion+'
							SUM(cchicaotro)cchicaotro,SUM(cortesias)cortesias,SUM(cxc)cxc,SUM(credito_sc)credito_sc, SUM(descuentos)descuentos,'+@totalPropina+'SUM(cuponesPrepagado )cuponesPrepagado,SUM(cashless)cashless,'+@totaltransferencia+'
							SUM(sobrante)sobrante'


				set @query = '
								select '+@columna+' 
								from #TotalConsiliacion 
								union
								select '+@total+'
								FROM #TotalConsiliacion'

exec (@query)


--end

drop table #tiempo,#retencion, #ccc,#deposito,#tarjeta, #cajachica,#csc,#otros,#TotalConsiliacion --,#sf
end


**********************para pruebas **************
insert into dintrans (Cod_Cierre,Cod_Cajero,Fecha,Valor,Cod_Restaurante,Num_trans,Cod_FormaPago) 
						values ('K138R0003074','MOTTO','2022-02-25 00:00:00.000',120,744,1,1640);


************************sp ultima modificacion ********************
USE [SirSql_Ecu]
GO
/****** Object:  StoredProcedure [dbo].[spConciliacionBancariaTotal]    Script Date: 08/03/2022 12:47:34 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROC [dbo].[spConciliacionBancariaTotal]
(@rest int, @fechaI datetime, @fechaF datetime, @perfil int = null)
as
Begin
	declare @cadena int, @dias int
	declare @columna as varchar(max), @total as varchar(max), @query varchar(max), 
			 @transferencias as varchar(max) = '', @totaltransferencia as varchar(max)='',
			 @fidelizacion as varchar(max)='' , @totalfidelizacion as varchar(max)='',
			 @notaDebCre as varchar(max) = '', @totalnotaDebCre as varchar(max) = '',
			 @totalPropina as varchar(max) = '', @propina as varchar(max) ='';
				   
																	
	set @cadena=(select cod_cadena from Restaurante where Cod_Restaurante=@rest)
--obtengo las fechas y guardo en una tabla temporal
set dateformat dmy
select fecha 
into #tiempo
from timedim where Fecha between @fechaI and @fechaF
--valores de depositos y anticipos
select d.Fecha_Cierre fecha,sum(isnull(ap.Valor_Anticipo,0)) anticipos,max(d.Num_Papeleta) numpapel,sum(d.Efectivo_Banco) efectivo,
sum(d.Monedas_Tevcol) tevcol,sum(isnull(d.Notas_Debito,0))notas_debito,sum(isnull(d.Notas_Credito,0))notas_credito,sum(d.Num_Cheques) num_cheques,sum(d.Valor_Cheques) valor_cheques,((sum(d.Efectivo_Banco)+sum(d.Valor_Cheques)+sum(isnull(d.Notas_Credito,0)))-sum(isnull(d.Notas_Debito,0))) deposito
into #deposito
from Depositos d
left join AnticipoPago ap on d.Cod_Deposito=ap.Cod_Deposito and ap.estado<>0
where d.Cod_Restaurante=@rest and d.Fecha_Cierre between @fechaI and @fechaF and d.estado<>0 
group by d.Fecha_Cierre
--valores de creditos, canjes y cortesias
select Total.Fecha,sum(Total.credito)credito,SUM(Total.canje)canje,SUM(Total.Cortesia_Operaciones)Cortesia_Operaciones,SUM(Total.Cortesia_Mercadeo)Cortesia_Mercadeo 
into #ccc
from (
	select Fecha,isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from(
	select  convert(varchar(11),s.Fecha_Canjeado,103)Fecha,count(s.Cod_Cupon)Cantidad,SUM(Precio)Valor,  tc.Cod_Canje,tc.Descripcion 
	from Solicitud_Cupon s
	inner join Detalle_Solicitud ds on s.Cod_Detalle_Solicitud = ds.Cod_Detalle_Solicitud
	inner join TipoCCC tc on ds.Cod_Canje = tc.Cod_Canje
	where s.Cod_Restaurante=@rest and convert(varchar(11),s.Fecha_Canjeado,103) between @fechaI and @fechaF
	group by tc.Cod_Canje,tc.Descripcion,convert(varchar(11),s.Fecha_Canjeado,103))a
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
	 union all
	select Fecha, isnull([Credito],0)credito, isnull([Canje],0)canje, isnull([Cortesia Operaciones] ,0)Cortesia_Operaciones,isnull([Cortesia Mercadeo],0)Cortesia_Mercadeo 
	from (
		  select dt.Fecha,sum(dt.Valor) Valor,tc.Descripcion from DinTrans dt
		  inner join Cupones c on dt.Cod_Cupon=c.Cod_Cupon
		  inner join CuponCliente cc on c.Cod_CuponCliente=cc.Cod_CuponCliente
		  inner join TipoCCC tc on cc.Cod_Canje=tc.Cod_Canje
		  where dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF and dt.Cod_Cupon is not null
		  group by dt.Fecha,tc.Descripcion) t
	pivot (sum(valor) FOR descripcion in ([Credito], [Canje], [Cortesia Operaciones],[Cortesia Mercadeo])) piv
)Total group by Total.Fecha
--valores de retencion
select Fecha,[RETENCION] fuente,[RETENCION_IVA] iva,[TOTAL] total,[CUENTAS COBRAR] cxc,[CAJA CHICA OTROS] cchicaotro,[CORTESIAS]  
into #retencion
from (      
      SELECT dt.Fecha, fp.Nombre descripcion,sum(dt.valor) Valor
      FROM formaspago fp
      LEFT JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=4 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF --and fp.nombre like 'Retencion%'
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR descripcion in ([RETENCION], [RETENCION_IVA],[TOTAL],[CUENTAS COBRAR],[CAJA CHICA OTROS],[CORTESIAS])) piv
--valor de las tarjetas de credito
SELECT dt.Fecha,sum(dt.valor) valor_tarjeta,SUM(dt.Num_Trans) num_tarjeta
into #tarjeta
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE fp.Cod_TipoF=1 and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre<>'TOTAL' and fp.nombre<>'CASHLESS'
GROUP BY  dt.Fecha
--valor de las cajas chicas
SELECT dt.Fecha,sum(cc.Total) valor_cchica 
into #cajachica
FROM dbo.DinTrans dt 
LEFT JOIN dbo.CierreChica cc ON cc.Cod_CierreChica=dt.Num_CajaChica
WHERE dt.Num_CajaChica IS NOT NULL and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
group by dt.Fecha
--creditos sin cupones
select dt.Fecha,sum(dt.Valor) credito_sc 
into #csc
from DinTrans dt 
where dt.Cod_Cliente is not null and dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF
group by dt.Fecha
--cupones prepagados - multimarca
SELECT dt.Fecha,sum(dt.valor) cuponPrepagado
into #cuponesPrepagados
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre = 'CUPON PREPAGADO'
GROUP BY  dt.Fecha
--otros
set dateformat dmy
select Fecha,[DESCUENTOS] descuentos,[DESCUENTOS PIXEL] descuento_pixel,[CREDITO NOE] credito_noe,[CORTESIA NOE] cortesia_noe,[PROPINA],[COMISION PROPINA] comision_propina,[TRANSFER BR - CN] transferencia
into #otros
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE fp.cod_tipoF=2 and fp.Nombre not in ('efectivo','AUTOCONSUMOSS') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([DESCUENTOS],[DESCUENTOS PIXEL], [CREDITO NOE],[CORTESIA NOE],[PROPINA],[COMISION PROPINA],[TRANSFER BR - CN])) piv
--fidelizacion
set dateformat dmy
select Fecha,[RECARGA EFECTIVO] AS recarga_efectivo,[CONSUMO RECARGA] AS consumo_recarga  
into #otros_fidelizacion
from (      
      SELECT dt.fecha, fp.Nombre, sum(dt.valor) Valor
      FROM  formaspago fp
      left join DinTrans dt ON fp.cod_formapago=dt.cod_formapago
      WHERE /*fp.cod_tipoF=2 and*/ fp.Nombre in ('RECARGA EFECTIVO','CONSUMO RECARGA') and dt.Cod_Restaurante=@rest and dt.Fecha between @fechaI and @fechaF
      GROUP BY dt.Fecha, fp.Nombre) t
pivot (sum(valor) FOR nombre in ([RECARGA EFECTIVO],[CONSUMO RECARGA])) piv
--cashless
SELECT dt.Fecha,sum(dt.valor) cashless
into #otros_cashless
from  formaspago fp 
LEFT OUTER JOIN DinTrans dt ON fp.cod_formapago=dt.cod_formapago
WHERE dt.cod_restaurante=@rest and dt.fecha between @fechaI and @fechaF and fp.nombre = 'CASHLESS'
GROUP BY  dt.Fecha
--armar el query final

select convert(varchar(12),ti.fecha,103) fecha,
isnull(re.total,0)+isnull(ccc.credito,0)+isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+ISNULL(Cortesia_Mercadeo,0) total,
isnull(de.anticipos,0)anticipo,
isnull(re.fuente,0)fuente, 
isnull(re.iva,0)iva, 
isnull(de.numpapel,0)numpapel, 
isnull(de.efectivo,0)efectivo, 
isnull(de.tevcol,0)tevcol,
isnull(de.notas_debito,0)notas_debito,
isnull(de.notas_credito,0)notas_credito,
isnull(de.num_cheques,0)num_cheque, 
isnull(de.valor_cheques,0)valor_cheque, 
isnull(de.deposito,0)deposito, 
isnull(ta.num_tarjeta,0)num_tarjeta,
isnull(ta.valor_tarjeta,0)valor_tarjeta,
isnull(cc.valor_cchica,0)cchica, 
isnull(ccc.canje,0)canje, 
isnull(ccc.Cortesia_Operaciones,0)cortesia, 
isnull(ccc.credito,0)credito, 
isnull(ccc.Cortesia_Mercadeo,0)Cortesia_mark,
isnull(re.cchicaotro,0)cchicaotro,
isnull(re.cortesias,0)cortesias, 
isnull(re.cxc,0)cxc, 
isnull(csc.credito_sc,0)credito_sc,
isnull(otfi.recarga_efectivo, 0) AS recarga_efectivo,
isnull(otfi.consumo_recarga, 0) AS consumo_recarga,
isnull(otca.cashless, 0) AS cashless,
(isnull(ot.descuentos,0)+isnull(ot.descuento_pixel,0))descuentos,  
isnull(ot.transferencia, 0) transferencia,
	CASE(select COUNT(*) from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE in ('CREDITO NOE')) when 0 then 0.001 else round(isnull(ot.credito_noe,0),2) end credito_noe,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 AND Cod_Cadena=@cadena AND 
	NOMBRE IN ('CORTESIA NOE')) when 0 then 0.001 else round(isnull(ot.cortesia_noe,0),2)end cortesia_noe,
	case(select COUNT(*) from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('PROPINA'))when 0 then 0.001 else  round(isnull(ot.propina,0),2)end propina,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('COMISION PROPINA'))when 0 then 0.001 else round(isnull(ot.comision_propina,0),2)end comision_propina, round(isnull(cp.cuponPrepagado,0),2) cuponesPrepagado,
	case(select COUNT(*)from FormasPago where Cod_TipoF=2 and Cod_Cadena=@cadena and
	NOMBRE in ('TRANSFER BR - CN'))when 0 then 0.001 else round(isnull(ot.transferencia,0),2)end tranferencia,
(
	 isnull(ta.valor_tarjeta,0)
    +isnull(cc.valor_cchica,0)
    +isnull(ccc.canje,0) 
    +isnull(ccc.Cortesia_Operaciones,0)  
    +isnull(ccc.credito,0)
    +isnull(ccc.Cortesia_Mercadeo,0)
	+isnull(otfi.recarga_efectivo,0)
	+isnull(otfi.consumo_recarga,0)
    +isnull(otca.cashless,0)
	+isnull(re.cchicaotro,0)
    +isnull(re.cortesias,0)
    +isnull(re.cxc,0)
    +isnull(csc.credito_sc,0)  
    +isnull(re.fuente,0)
	---isnull(de.notas_debito,0)
	--+isnull(de.notas_credito,0)
	--+isnull(ot.descuentos,0)
	+isnull(ot.transferencia, 0) 
	+ISNULL(cp.cuponPrepagado, 0)
    +isnull(re.iva,0))+isnull(de.deposito,0)-(isnull(re.total,0)+isnull(ccc.credito,0)+
	isnull(ccc.canje,0)+isnull(ccc.Cortesia_Operaciones,0)+isnull(ccc.Cortesia_Mercadeo,0)
	)sobrante

	
into #TotalConsiliacion    
from #tiempo ti
left join #deposito de on ti.fecha=de.fecha
left join #retencion re on ti.fecha=re.fecha
left join #tarjeta ta on ti.fecha=ta.fecha
left join #cajachica cc on ti.fecha=cc.fecha
left join #ccc ccc on ti.fecha=ccc.fecha
left join #csc csc on ti.fecha=csc.fecha
left join #otros ot on ti.fecha=ot.fecha
LEFT JOIN #cuponesPrepagados AS cp ON cp.Fecha = ti.Fecha
LEFT JOIN #otros_fidelizacion AS otfi ON ti.Fecha = otfi.Fecha
LEFT JOIN #otros_cashless AS otca ON ti.Fecha = otca.Fecha
order by ti.fecha 


set @dias = (select count(Fecha) from #TotalConsiliacion)
--print @dias

	if exists (select Valor 
				from ConfiguracionXPais
				where Configuracion ='TRANS BR-CN BASKINS' and Estado=1 and Valor = @cadena )
	  BEGIN 
			SET @transferencias = 'round(tranferencia,2)transferencia,'	
			SET @totaltransferencia = 'sum(transferencia) transferencia,'
		
	END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='FIDELIZACION' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @fidelizacion = 'ROUND(recarga_efectivo,2)recarga_efectivo,ROUND(consumo_recarga,2)consumo_recarga,'	
			SET @totalfidelizacion = 'SUM(recarga_efectivo)recarga_efectivo,SUM(consumo_recarga)consumo_recarga,'	

   END ELSE if exists (select Valor 
						 from ConfiguracionXPais
						 where Configuracion ='PROPINA' and Estado=1 and Valor = @cadena) 
	BEGIN

		   SET @propina = 'case when propina =0.001 then 0.001 else round(propina,2) end propina,
case when comision_propina=0.001 then 0.001 else round(comision_propina,2) end comision_propina, '	
			SET @totalPropina = 'case when avg(distinct propina) = 0.001 then 0.001 else SUM(propina) end propina, 
case when avg(distinct comision_propina) = 0.001 then 0.001 else SUM(comision_propina) end comision_propina, '	

   END  
  -- if exists ( SELECT cp.Valor
  --             FROM Perfil p
  --             INNER JOIN (SELECT top(1) Valor 
		--                   FROM ConfiguracionXPais 
  --                         WHERE Configuracion = 'Perfil') cp on p.Nombre like cp.Valor+' %'  COLLATE Modern_Spanish_CI_AS  
  --            INNER JOIN Users usr on p.Cod_Perfil = usr.Cod_Perfil
  --            WHERE Cod_Usuario = @perfil)
		--BEGIN 
			SET @notaDebCre = 'notas_debito,notas_credito,'	
			SET @totalnotaDebCre = 'SUM(notas_debito)notas_debito,SUM(notas_credito)notas_credito,'
		--END


	set @columna = 'Fecha,round(total,2)total,round(anticipo,2)anticipo,round(fuente,2)fuente,round(iva,2)iva,numpapel,round(efectivo,2)efectivo,round(tevcol,2)tevcol,'+@notaDebCre+'round(num_cheque,2)num_cheque,round(valor_cheque,2)valor_cheque,round(deposito,2)deposito,
							num_tarjeta,round(valor_tarjeta,2)valor_tarjeta,round(cchica,2)cchica,round(canje,2)canje,
							round(cortesia,2)cortesia,round(credito,2)credito,round(Cortesia_mark,2)Cortesia_mark,'+@fidelizacion+'
							round(cchicaotro,2)cchicaotro,round(cortesias,2)cortesias,round(cxc,2)cxc,round(credito_sc,2)credito_sc, round(descuentos,2)descuentos, '+@propina+'round(cuponesPrepagado,2)cuponesPrepagado,ROUND(cashless,2)cashless,'+@transferencias+'ROUND(sobrante,2)sobrante';
	SET @total = '''Total'' Fecha, SUM(total)total,SUM(anticipo)anticipo,SUM(fuente)fuente,SUM(iva)iva, ''--------'' numpapel,SUM(efectivo)efectivo,SUM(tevcol)tevcol,'+@totalnotaDebCre+'
							SUM(num_cheque)num_cheque,SUM(valor_cheque)valor_cheque,SUM(deposito)deposito, SUM(num_tarjeta)num_tarjeta,SUM(valor_tarjeta)valor_tarjeta,SUM(cchica)cchica,
							SUM(canje)canje,SUM(cortesia)cortesia,SUM(credito)credito,SUM(Cortesia_mark)Cortesia_mark,'+@totalfidelizacion+'
							SUM(cchicaotro)cchicaotro,SUM(cortesias)cortesias,SUM(cxc)cxc,SUM(credito_sc)credito_sc, SUM(descuentos)descuentos,'+@totalPropina+'SUM(cuponesPrepagado )cuponesPrepagado,SUM(cashless)cashless,'+@totaltransferencia+'
							SUM(sobrante)sobrante'


				set @query = '
								select '+@columna+' 
								from #TotalConsiliacion 
								union
								select '+@total+'
								FROM #TotalConsiliacion'

exec (@query)


--end

drop table #tiempo,#retencion, #ccc,#deposito,#tarjeta, #cajachica,#csc,#otros,#TotalConsiliacion --,#sf
end

rama
gifscard-aereopuertos
*********************************
1E036R0003008 //efectivo
1E036R0003008 //cashlees
******************************************
DECLARE @totalPago						FLOAT, 
			@totalCab						FLOAT, 
			@IDCadena						INT,
			@IDRestaurante					INT, 
			@FechaProceso					DATETIME,
			@FechaPeriodo					DATE,
			@CodPeriodo						VARCHAR(15),
			@TotalFactura					FLOAT,
			@TotalFormaPago					FLOAT,
			@mensaje						VARCHAR(100),
			@fidelizacionActivo				VARCHAR(2),
			@IDCliente						VARCHAR(40),
			@IDCabeceraOrdenPedido			VARCHAR(40),
			@IDUserPos						VARCHAR(40),
			@IDPeriodo						VARCHAR(40),
			@IDEstacion						VARCHAR(40),
			@IDControlEstacion				VARCHAR(40),
			@IDCabeceraFactura				VARCHAR(20),
			@telefono						BIGINT,
			@codFactura						NVARCHAR(30),
			@Medio							VARCHAR(50),
			@tipoEntrega					VARCHAR(20),
			@tipoTransaccion				VARCHAR(50),
			@diferencia_precios             INT,   
			@aplicaFidelizacionMedio		VARCHAR(2);
			

				  EXEC dbo.App_IngresarInfoFacturaCabeceraDescuentos '0000001010-010101' 
																		,744 
																		,'4AD5FE5D-98A9-48D9-BEE9-0C16B96844D2' 
																		,'37FA9768-A167-EA11-80EC-000D3A019254' 
																		,'A13ADB4E-F2A8-4CC9-BA4B-76B261E160B1' 
																		,'CF47DF79-C9A3-EC11-9AC1-B8CB29BB65BA' 	
																		,'4F96FB2A4-C29E-EC11-9AC1-B8CB29BB65BA'  
																		,'166F8BE5-24B4-4B01-93BC-3328BAF0A9B8' 
																		,'App'
																		,@IDCabeceraFactura			OUTPUT
																		,@TotalFactura				OUTPUT
																		,@TotalFormaPago			OUTPUT;


select round(2.325, 2);
select round(((10.00 / (1 + 12.00 / 100)) *  0.260400),2)
select round(((10.00 / (1 + 12.00 / 100)) *  0.260400),3)
select round(((10.00 / (1 + 12.00 / 100)) *  0.260400),3)
************************************************************ producción ****************
https://siruio.kfc.com.ec/
usuario: dmora y clave: ecuador*17

instancia: sqldbsg-uio-instr.34bc2f509496.database.windows.net
usaurio: dev_darwin
clave: developer*424


*******************************

--Tarjetas Cashless
				SELECT	cfp.Nombre, ABS(SUM(ROUND(ISNULL(dt.valor,0),2))) AS tmpFdtotal, dt.fecha AS tmpFdfecha,
						dt.cod_restaurante AS tmpFdCod_Rest,dt.cod_cierre AS tmpFdCod_cierre,
						CASE 
							WHEN MAX(CAST(dt.recap AS BIGINT)) IS NULL THEN 0 
							ELSE MAX(CAST(dt.recap AS BIGINT)) 
						END AS tmpFdRecap, 
						ROW_NUMBER() OVER(PARTITION BY dt.fecha ORDER BY dt.fecha ) AS tmplineasFd, cfp.Cod_FormaPago
				INTO #tmp_Cashless
				FROM dbo.DinTrans			AS dt
				INNER JOIN FormasPago		AS cfp ON dt.Cod_FormaPago=cfp.Cod_FormaPago
				INNER JOIN TipoFormaPago	AS tfp ON cfp.Cod_TipoF= tfp.Cod_TipoF
				WHERE	cfp.Nombre IN ('CASHLESS') AND cfp.cod_cadena=@idCadena AND 
						dt.fecha BETWEEN  @fechaI AND @fechaF
				GROUP BY cfp.Nombre, dt.fecha, dt.cod_restaurante, dt.cod_cierre, cfp.Cod_FormaPago
				
				
				
				--Tarjetas Cashless
					IF EXISTS(
						SELECT	tmpFdCod_cierre 
						FROM	#tmp_Cashless 
						WHERE	nombre='CASHLESS' AND tmpFdCod_Rest= @Cod_Restaurante 
								AND  tmpFdfecha=@fecha AND tmpFdtotal <>0
					) BEGIN
						SET @ContRec =@ContRec + 1;		 
						--INSERT INTO [erp].[DetalleDiarioVenta] 
					    SELECT	@Cod_Cierre					AS ZXBLNR,
								@ContRec					AS ZBUZEI,
								CASE 
									WHEN vw.Debito_Credito = 1 THEN 40
									ELSE 50
								END							AS ZBSCHL,
								'S'							AS ZKOART,
								CASE 
									WHEN vw.Debito_Credito = 1 THEN 'S' 
									ELSE 'H'  
								END							AS ZBSCHL,
								''							AS ZMWSKZ,
								fd.tmpFdtotal				AS ZDMBTR,
								fd.tmpFdtotal				AS ZWRBTR,
								fd.tmpFdtotal				AS ZPSWBT,
								0							AS ZHWBAS,
								0							AS ZFWBAS,
								config.tmpMoneda			AS ZPSWSL,
								''							AS ZMWART,
								''							AS ZZUONR,
								@NombreDiario+SPACE(1)+vw.cod_tienda+SPACE(1)+convert(varchar(11),@fecha,100)+
								SPACE(1)+vw.descripcion		AS ZSGTXT,
								''							AS ZSAKNR,
								vw.Cta_Axapta				AS ZHKONT, 
								CASE	
								WHEN CentroCostos  =  'CCosto' 
									AND dimension2 =  'Local'	THEN @ctrCosto
								WHEN CentroCostos  =  'CCosto' 
									AND dimension2 <> 'Local'	THEN @ctrBeneficio
								ELSE ''
							END								AS ZKOSTL,
							''								AS ZTAXNUM,
							CASE	
								WHEN CentroCostos  =  'Beneficio' 
									AND dimension2 =  'Local'	THEN @ctrCosto
								WHEN CentroCostos  =  'Beneficio' 
									AND dimension2 <> 'Local'	THEN @ctrBeneficio
								ELSE ''
							END								AS ZPRCTR,
								0							AS ZTXBH2,
								@fecha,
								@idCadena,
								@Cod_Restaurante ,'' , null, ''
						 INTO #temporal_demo_cashless 
						 FROM	#tmp_cashless AS fd 
							INNER JOIN #tmp_Configuracion AS config ON fd.tmpFdCod_Rest = config.tmpCodRestaurante 
							INNER JOIN ViewVtaPorcentuales AS vw ON fd.tmpFdCod_Rest=vw.cod_restaurante
							WHERE	vw.descripcion='CASHLESS' AND fd.nombre='CASHLESS' AND 
								fd.tmpFdCod_Rest= @Cod_Restaurante AND fd.tmpFdfecha=@fecha								
					END
					select * from #temporal_demo_cashless return


DROP TABLE #tmp_Cashless;
*************************************
select * from FormasPago where Cod_Cadena = 8

EXEC erp.DiarioVentas 8,'2022-03-22','2022-03-22',9571

EXEC erp.DiarioVentas_Ind 8, '2022-03-22','2022-03-22', 9571, 538

SELECT * FROM [erp].[DetalleDiarioVenta] 

select top(10)* from ViewVtaPorcentuales WHERE	descripcion='CASHLESS'

select top(10)* from [erp].[DetalleDiarioVenta]  where COD_CADENA = 8 order by FECHA desc

dev_cristina
 sqldbsg-gye-instr.34bc2f509496.database.windows.net
sqldbsg-gye-instr.ba2918dce0ee.database.windows.net
ccontreras
developer*613



*************************************
[erp].[InformeDiarioVentas] //modificado A PARTIR DEL DE PRODUCCION
[erp].[DiarioVentas_Ind] //modificado A PARTIR DEL DE PRODUCCION
[erp].[DiarioVentas] //modificado A PARTIR DEL DE PRODUCCION

'CXC T CASHLESS AER' 
**************************
select top(100)* from [erp].[DetalleDiarioVenta]  where COD_CADENA = 8 order by FECHA desc

select * from [erp].[DetalleDiarioVenta] where ZXBLNR = 'E036R0003030'
select * from [erp].[DetalleDiarioVenta] where ZHKONT = '100009817'

select * from TipoFormaPago
*************************** Caja chica cambio de estado ****************

set dateformat dmy;
insert into PresupuestosTienda (id,CodRestaurante,Presupuesto,Fecha)
values(NEWID(),40,500,'01/04/2022')

select Cod_TipMovInv from TipoMov where Descripcion='Caja Chica'

select * from CajaChica where Estado = 1

select * from PresupuestosTienda where CodRestaurante = 744

set dateformat dmy;
insert into PresupuestosTienda (id,CodRestaurante,Presupuesto,Fecha)
values(NEWID(),744,500,'01/04/2022')

set dateformat dmy update CajaChica set Total='8' where Num_CajaChica='K004J0003010'

update CajaChica set estado=0 where Num_CajaChica='K004J0003010'
*****Archivos modificados ******
C:\laragon\www\1sir\cajachica\menu_cajachica.php // se aumenta para asentar en la linea 169
C:\laragon\www\1sir\js\ajax_cajachica.js   // se crea la funcion fn_CajaChicaCambioEstado y se llama en la linea 547
C:\laragon\www\1sir\cajachica\configura_cajachica.php // se crea la opcion EditCajaChicaEstado
C:\laragon\www\1sir\clases\clase_cajachica.php // se agraga el case EditCajaChicaEstado linea 122 en la linea 262 se agrego pendiente 1
C:\laragon\www\1sir\clases\clase_seguridades.php // se agrega al final una funcion para validar el perfil
C:\laragon\www\1sir\imagenes\BARRA\barra_cambioestado_s.png
C:\laragon\www\1sir\imagenes\BARRA\barra_cambioestado.png

*******sp modificados*******
insert into ConfiguracionXpais (Pais,Configuracion,Valor,Modulo,Cod_pais,descripcion,estado)
values('ECUADOR','Perfil Cambio Estado Pendiente Relacionado','Administrador(Sistemas)','Gastos Caja Chica',1,'Configuracion para el perfil Administrador(Sistemas) que permite el cambio de estado en gastos caja chica',1)

insert into ConfiguracionXpais (Pais,Configuracion,Valor,Modulo,Cod_pais,descripcion,estado)
values('ECUADOR','Perfil Cambio Estado Pendiente','Auditor Local','Gastos Caja Chica',1,'Configuracion para el perfil Auditor Local que permite el cambio de estado en gastos caja chica',1)

insert into ConfiguracionXpais (Pais,Configuracion,Valor,Modulo,Cod_pais,descripcion,estado)
values('ECUADOR','Perfil Cambio Estado Relacionado','Reporte Tarjetas','Gastos Caja Chica',1,'Configuracion para el perfil Reporte Tarjetas que permite el cambio de estado en gastos caja chica',1)

[dbo].[Din_InsertCajaChica]  // se cambia el @estado a 1 

echo '<a href="#" onclick="fn_accionar('."'Acentar'".','.$lc_restaurante.')" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('."'Acentar'".','."''".','."'../../imagenes/BARRA/barra_acentar_s.png'".',1)" border=0><img name="Acentar" src="../../imagenes/BARRA/barra_acentar.png" border=0 class="solo_bordes"></a>';


**********************************************************************************
echo '<a href="#" onclick="fn_CajaChica('."'".'Modificar'."'".',-1,'.$lc_restaurante.')" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('."'".'btnIngArticulo'."'".','."''".','."'".'../imagenes/BARRA/barra_grabar_s.png'."'".',1)" border=0><img name="btnIngArticulo" src="../imagenes/BARRA/barra_grabar.png" border=0></a>';  

update CajaChica set Estado=6
                where Num_CajaChica='K004J0003011'

if($lc_resultado_evento==1 && $lc_estado === 'EXPORTADO'){

echo '<a id="btnPendiente" href="#" onclick="fn_CajaChicaCambioEstado('."'".'Pendiente'."'".',-1,'.$lc_restaurante.')" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('."'reporte'".','."''".','.'../imagenes/BARRA/barra_abrir_s.png'."'".',1)" border=0><img name="Pendiente" src="../imagenes/BARRA/barra_abrir.png" border=0></a>';  

echo '<a id="btnRelacionado" href="#" onclick="fn_CajaChicaCambioEstado('."'".'Relacionado'."'".',-1,'.$lc_restaurante.')" onMouseOut="MM_swapImgRestore()" onMouseOver="MM_swapImage('."'reporte'".','."''".','.'../imagenes/BARRA/barra_abrir_s.png'."'".',1)" border=0><img name="btnIngArticulo" src="../imagenes/BARRA/barra_abrir.png" border=0></a>';  


update CajaChica set Estado=6
                where Num_CajaChica='K004J0003012'

				select cf.Valor from ConfiguracionXpais as cf
        INNER JOIN  Perfil as pe on CAST(cf.Valor AS VARCHAR(100)) = CAST(pe.Nombre AS VARCHAR(100)) COLLATE Modern_Spanish_CI_AS
        INNER JOIN users as us on us.Cod_perfil = pe.Cod_Perfil 
        WHERE us.Cod_Usuario= 8135 and 
              (cf.Configuracion = 'Perfil Cambio Estado Pendiente' OR  
              cf.Configuracion = 'Perfil Cambio Estado Pendiente Relacionado') and 
              cf.Estado = 1 and
              pe.Estado = 1 --and
              --us.Estado = 1

		select * from users where Cod_Perfil = 37
		select * from users where Cod_Perfil = 164
		select * from Perfil

		select * from ConfiguracionXpais

select * from users where Cod_Usuario = 9571 //nsanchez
select * from Perfil

veronica jacome		perfil (contabilidad) recarga tarjetas 4299 perfil 164
EDGAR PATRICIO NAULA ZHANGALLIMBAY  usuario 1219 perfil 37 auditor local
luis sanchez usuario 9466  Gerente Operaciones 3

**********************
select @cupon as cupon
		select @efechaf as efechaf
		select @fechaI as fechaI
		select @cupona as cupona
		select @ivaa as ivaa
		select @ivaa as ivaa
		select @rest as @est
		
		
		SET NOCOUNT ON; SET ANSI_WARNINGS ON SET ANSI_PADDING ON exec Din_GenerarPyGProyectado 40,'13/06/2022','13/06/2022'
		
		
		declare @erest as int,@efechai varchar(12),@efechaf varchar(12)
set @erest = 40
set @efechai = '13/06/2022'
set @efechaf = '13/06/2022'
declare @rest as int,@fechai varchar(12),@fechaf varchar(12)
    set @rest=@erest
    set @fechai=@efechai
    set @fechaf=@efechaf
declare @cupon float,@corteo float,@cortem float,@neta float, @corte2 float,@descuento float,@cupona float, @ivaa float ,@VentaLimp float
	

set @cupon=(select isnull(sum(din.valor/(dbo.fn_div_iva(@efechaf))),0) from dbo.DinTrans din 
			inner join dbo.Cupones cup on cup.Cod_Cupon=din.Cod_Cupon
			where din.Cod_Restaurante=@rest and (din.Fecha between @fechaI and @fechaF ))
		select @cupona=isnull(SUM(TPVP_CAutomatico),0),@ivaa=isnull(SUM(TIVA_CAutomatico),0) from dbo.CierreCajas 
			where Cod_Restaurante=@rest and Fecha between @fechaI and @fechaF


select niv.Cod_Grupo,Niv.Padre,convert(varchar(50),niv.Descripcion) Descripcion,convert(decimal(12,2),Valor) Valor,Niv.OrdenImpresion,Niv.Operador 
			INTO #Temp4NivelPyG 
			from (
				select [Venta Bruta]+(@cupon*(dbo.fn_div_iva(@efechaf)))+@cupona [Venta Bruta],
					   @ivaa+[Impuesto Iva]+(@cupon*Iva) [Impuesto Iva],[Compensacion Solidaria],
					   [Impuesto Servicio], ([Venta Neta] + @cupona - @ivaa) [Venta Neta]
				--Servicio*([Bruta])/([Venta Bruta]+(@cupon*1.12)) Servicio,[Iva],[Bruta] 					
				FROM (
					select sum (Venta_Neta) AS [Venta Neta],abs(sum(cc.Iva)) [Impuesto Iva],Sum(cc.Venta_Bruta) [Venta Bruta],sum(cc.servicios) [Impuesto Servicio],
					SUM(isnull(Compensacion,0)) AS [Compensacion Solidaria],
					--round(sum(cc.servicios)/sum(cc.Venta_Neta),2) Servicio,
					case sum(cc.Venta_Neta) when 0 then 0 else round(sum(cc.Iva)/sum(cc.Venta_Neta),2) END [Iva],
					case sum(cc.Venta_Neta) when 0 then 0 else round(sum(cc.Venta_Bruta)/sum(cc.Venta_Neta),2) end [Bruta]
					from dbo.CierreCajas cc
					where Estado=1 and cod_restaurante=@rest and Fecha between @fechaI and @fechaF
				)tem2
			) p
			
			UNPIVOT 
			(Valor FOR Descripcion IN ([Venta Bruta],[Impuesto Servicio],[Impuesto Iva],[Compensacion Solidaria], [Venta Neta])
			) tot
			inner join dbo.NivelesPyG niv on niv.Descripcion=tot.Descripcion	
*************************reportes******************
C:\laragon\www\1sir\cajas\reportes\conciliacion\consolidado_cierre_mes_generado.php
C:\laragon\www\1sir\cajas\reportes\conciliacion\consolidado_cierre_mes_excel.php
C:\laragon\www\1sir\mix\reporte_mix.php		
C:\laragon\www\1sir\clases\clase_mix.php
C:\laragon\www\1sir\mix\excel_mix.php
ALTER PROCEDURE [dbo].[TotalesGenerales_Mix]	
EXEC dbo.ReporteMix_Bandera 
EXEC dbo.ReporteMix_Bandera_CostosIniciales 
EXEC dbo.ReporteMix


<td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
                <td style="border:0px solid #999" width="70" align="center"></td>
***************************
SET NOCOUNT ON; 
set dateformat dmy declare @VentaTotalNeta as decimal(12,2) set @VentaTotalNeta=[dbo].[din_VentaTotal2] (40,'29/05/2022','29/05/2022','Neta') 
SELECT @VentaTotalNeta
select plu.Descripcion, 
sum(tra.Cantidad) Cantidad, 
cab.Estado, 
CAST(avg(tra.PrecioB) as DECIMAL (12,2)) PrecioB, 
sum(tra.TotalB) TotalB, 
tra.PrecioN PrecioN, 
sum(tra.TotalN) TotalN, 
CAST(avg(Costo) as DECIMAL (12,2)) Costo, 
sum(Costo*tra.Cantidad) Costo_total, 
(sum(TotalN)/NULLIF(@VentaTotalNeta,0))*100 Porcentual_Mix, 
case sum(TotalN) when 0 then 0 
else (sum(Costo*Cantidad)/NULLIF(sum(TotalN),0))*100 end 
Porcentual_Costo, 
case sum(TotalN) when 0 then 0 else (100-((sum(Costo*Cantidad)/NULLIF(sum(TotalN),0))*100)) end Contribucion, 
case sum(TotalN) when 0 then 0 else ((sum(TotalN)-(sum(Costo*Cantidad)))/NULLIF(sum(tra.Cantidad),0)) end Contribucion_unitaria, 
case sum(TotalN) when 0 then 0 else (sum(TotalN)-(sum(Costo*Cantidad))) end Contribucion_total,
res.Cod_Tienda 
from MixCab cab inner join MixTrans tra on cab.Cod_MixCab=tra.Cod_MixCab 
inner join Restaurante res on res.Cod_restaurante=cab.Cod_restaurante 
inner join cierrecajas cj on cj.cod_restaurante=res.cod_restaurante 
inner join Categoria cat on cat.Cod_Categoria=res.Cod_Categoria 
inner join Plus plu on tra.cod_plu=plu.cod_plu 
inner join Precio_plu pre on pre.cod_plu=plu.cod_plu and cat.Cod_Categoria=pre.Cod_Categoria 
inner join DeptoPlus dep on dep.Cod_DeptoPlu=plu.Cod_DeptoPlu 
where cab.Estado=3 and 
pre.estado=1 and cj.Fecha= cab.Fecha and 
cab.Fecha BETWEEN '29/05/2022' and '29/05/2022' 
and cab.Cod_restaurante=40 
and plu.Cod_Clasificacion in(1,2,3,4,5,6) 
group by plu.Descripcion,cab.Estado,res.Cod_Tienda,tra.PrecioN order by TotalB desc

"%.2f"
"Menu_por_plus"
echo $lc_varios->fn_decimales_general(, 2);
echo $lc_varios->fn_decimales_general($total, 2);

SQL Server Management Studio						15.0.18386.0
SQL Server Management Objects (SMO)						16.100.46437.65
Microsoft Analysis Services Client Tools						15.0.19618.0
Microsoft Data Access Components (MDAC)						10.0.19041.1
Microsoft MSXML						3.0 6.0 
Microsoft .NET Framework						4.0.30319.42000
Operating System						10.0.19044




-- =============================================
-- Author:		Cristina Contreras
-- Create date: 15/06/2022
-- Description:	se cambia el tipo de dato a decimal
-- =============================================


if ($Tipo_Impuesto == 'Diferenciado')
                                     $total = $total + $IVA + $Servicios  + $ivacupon  +$Compensa  + $Descuentos ;

				
                
MixCab			
depositos validar la creacion de depositos		


select * from Users_Pos where usr_usuario like '%atonato%'		


 usuario maxpoint 


http://192.168.100.170:880/pos/corte_caja/desmontado_cajero.php



https://sirinternacional-dev.azurewebsites.net/
Usuario: pruebas
Clave:Pruebas12
Produccion Venzuela
https://sistemagerenteven.azurewebsites.net/
Usuario:ccontreras
Clave:developer*613


****************Ajustes**********
fn_articuloBodega --- comprueba l inventario en al toma fisica


fn_articuloAjuste --

lc_SelecTipo= document.getElementById("TipoMov");


lc_opcMov = document.getElementById("TipoMov").value;
	
    
	lc_validaEsado="ValidaEstadoMovimiento"; 
	ajax=nuevoAjax();
	ajax.open("POST", "configura_ajuste.php");
	ajax.setRequestHeader("Content-Type","application/x-www-form-urlencoded"); 
	ajax.send("tipo='"+lc_validaEsado+"'&restaurant="+lc_CodRest.value+"&Ajuste="+lc_ajuste+"&Movimiento="+lc_opcMov+"&fecha="+lc_fecha.value);
	ajax.onreadystatechange=function()
	{
		if (ajax.readyState == 4) {
			lc_respuestaEstado = ajax.responseText;
			if (lc_respuestaEstado > 0) {
				sir_alert("No puede crear un ajuste porque la Compra de Caja Chica esta en estado Por exportar.");
				return;
			}else{